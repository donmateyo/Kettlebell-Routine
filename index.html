<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover"
    />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta
      name="apple-mobile-web-app-status-bar-style"
      content="black-translucent"
    />
    <title>Simple Strength Program (PWA)</title>
    <meta
      name="description"
      content="A Simple Strength Program — Clean + Press and Front Squat, 30-min alternating sets, ladders and fixed reps with autoregulation. Offline PWA."
    />
    <meta name="theme-color" content="#111827" />
    <link
      rel="icon"
      href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Ccircle cx='32' cy='32' r='32' fill='%23111827'/%3E%3Cpath d='M45 26c0-7-5-12-13-12S19 19 19 26v2h2v-2c0-6 4-10 11-10s11 4 11 10v2h2v-2z' fill='%23f59e0b'/%3E%3Cpath d='M20 30h24c3 0 5 2 5 5v14c0 3-2 5-5 5H20c-3 0-5-2-5-5V35c0-3 2-5 5-5z' fill='%23f59e0b'/%3E%3C/svg%3E"
    />
    <style>
      :root {
        --bg: #0b1220;
        --panel: #111827;
        --muted: #94a3b8;
        --text: #e5e7eb;
        --accent: #f59e0b;
        --accent-2: #22c55e;
        --danger: #ef4444;
      }
      * {
        box-sizing: border-box;
      }
      html,
      body {
        margin: 0;
        height: 100%;
        background: var(--bg);
        color: var(--text);
        -webkit-text-size-adjust: 100%;
        touch-action: manipulation;
        font: 16px/1.35 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu,
          Cantarell, Noto Sans, Helvetica Neue, Arial, "Apple Color Emoji",
          "Segoe UI Emoji";
      }
      .app {
        max-width: 920px;
        margin: 0 auto;
        padding: calc(16px + env(safe-area-inset-top, 0px)) 16px
          calc(28px + env(safe-area-inset-bottom, 0px));
        display: grid;
        gap: 16px;
      }
      header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
      }
      h1 {
        font-size: 20px;
        margin: 0;
        letter-spacing: 0.2px;
      }
      .badge {
        font-size: 12px;
        color: var(--muted);
      }
      .grid {
        display: grid;
        gap: 12px;
      }
      @media (min-width: 840px) {
        .grid.cols-2 {
          grid-template-columns: 1fr 1fr;
        }
      }
      .card {
        background: var(--panel);
        border: 1px solid #1f2937;
        border-radius: 12px;
        padding: 12px;
      }
      .row {
        display: flex;
        gap: 8px;
        align-items: center;
        flex-wrap: wrap;
      }
      label {
        font-size: 13px;
        color: var(--muted);
      }
      select,
      input[type="number"] {
        background: #0b1020;
        color: var(--text);
        border: 1px solid #243047;
        border-radius: 10px;
        padding: 8px 10px;
        font-size: 16px;
        min-width: 100px;
      }
      .btn {
        border: 0;
        border-radius: 999px;
        padding: 10px 14px;
        font-weight: 600;
        background: #22283a;
        color: #e5e7eb;
        cursor: pointer;
        touch-action: manipulation;
        user-select: none;
      }
      .btn:hover {
        filter: brightness(1.05);
      }
      .btn.accent {
        background: var(--accent);
        color: #111;
      }
      .btn.good {
        background: var(--accent-2);
        color: #051b10;
      }
      .btn.danger {
        background: var(--danger);
      }
      .split {
        display: grid;
        grid-template-columns: 1fr auto;
        align-items: center;
      }
      .timer {
        font-feature-settings: "tnum" 1, "ss01" 1;
        font-variant-numeric: tabular-nums;
        font-size: 42px;
        text-align: center;
        padding: 8px 0 2px;
      }
      .subtle {
        color: var(--muted);
        font-size: 13px;
      }
      .exercise {
        display: grid;
        grid-template-columns: 1fr auto;
        align-items: center;
        gap: 6px;
        padding: 10px 12px;
        border-radius: 12px;
        background: #0b1020;
        border: 1px dashed #27324b;
      }
      .exercise.current {
        border-style: solid;
        border-color: var(--accent);
      }
      .pill {
        font-size: 12px;
        padding: 4px 8px;
        border-radius: 999px;
        background: #1f2937;
        color: #f1f5f9;
      }
      .pill.strong {
        background: #f59e0b;
        color: #111827;
        font-weight: 700;
      }
      .log {
        display: grid;
        gap: 6px;
        max-height: 280px;
        overflow: auto;
        padding-right: 4px;
      }
      .log-item {
        display: grid;
        grid-template-columns: auto 1fr auto;
        gap: 8px;
        align-items: center;
        background: #0b1020;
        border: 1px solid #1f2b43;
        border-radius: 10px;
        padding: 8px 10px;
      }
      /* Micro-animations */
      @keyframes fadeSlideIn {
        from {
          opacity: 0;
          transform: translateY(6px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .anim-in {
        animation: fadeSlideIn 180ms ease-out;
      }
      @keyframes pillPulse {
        0% {
          transform: scale(1);
        }
        30% {
          transform: scale(1.06);
        }
        100% {
          transform: scale(1);
        }
      }
      .pill.strong.pulse {
        animation: pillPulse 220ms ease-out;
      }
      @media (prefers-reduced-motion: reduce) {
        .anim-in,
        .pill.strong.pulse {
          animation: none !important;
        }
      }

      .note {
        font-size: 14px;
        color: var(--muted);
      }
      .mono {
        font-family: ui-monospace, SFMono-Regular, Menlo, Consolas,
          "Liberation Mono", monospace;
      }
      .hr {
        height: 1px;
        background: #1f2937;
        margin: 8px 0;
      }
      .toast {
        position: fixed;
        bottom: calc(env(safe-area-inset-bottom, 0px) + 18px);
        left: 50%;
        transform: translateX(-50%) translateY(12px);
        opacity: 0;
        background: rgba(17, 24, 39, 0.92);
        color: #e5e7eb;
        padding: 8px 12px;
        border-radius: 10px;
        font-size: 13px;
        border: 1px solid #1f2937;
        transition: opacity 0.2s ease, transform 0.2s ease;
        pointer-events: none;
        z-index: 999;
      }
      .toast.show {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
      }

      /* End-of-session summary sheet */
      .sheet {
        position: fixed;
        inset: 0;
        display: none;
        align-items: flex-end;
        justify-content: center;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1200;
        padding: 0 10px calc(env(safe-area-inset-bottom, 0px) + 10px);
      }
      .sheet.show {
        display: flex;
      }
      .sheet .panel {
        width: min(540px, 96vw);
        background: var(--panel);
        border: 1px solid #1f2937;
        border-radius: 16px 16px 12px 12px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.45);
        transform: translateY(20px);
        opacity: 0;
        transition: transform 0.2s ease, opacity 0.2s ease;
      }
      .sheet.show .panel {
        transform: translateY(0);
        opacity: 1;
      }
      .sheet .panel .head {
        padding: 12px 12px 4px;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }
      .sheet .panel .body {
        padding: 0 12px 12px;
      }
      .summary-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
        margin-top: 6px;
      }
      .kv {
        background: #0b1020;
        border: 1px solid #1f2b43;
        border-radius: 10px;
        padding: 8px 10px;
      }
      .kv .k {
        font-size: 12px;
        color: var(--muted);
      }
      .kv .v {
        font-family: ui-monospace, SFMono-Regular, Menlo, Consolas,
          "Liberation Mono", monospace;
        margin-top: 3px;
      }
      .sheet .actions {
        display: flex;
        gap: 8px;
        padding: 8px 12px 12px;
        flex-wrap: wrap;
      }
    </style>
  </head>
  <body>
    <div class="app">
      <header>
        <h1>Simple Strength Program</h1>
        <div class="row">
          <button id="installBtn" class="btn" disabled>Install</button>
          <span class="badge">Offline-ready</span>
        </div>
      </header>

      <section class="card">
        <div class="split">
          <div>
            <div class="row">
              <label>Week</label>
              <select id="weekSel">
                <option value="1">Week 1</option>
                <option value="2">Week 2</option>
                <option value="3">Week 3</option>
                <option value="4">Week 4</option>
                <option value="5">Week 5</option>
              </select>
              <label>Day</label>
              <select id="daySel">
                <option value="1">Day 1</option>
                <option value="2">Day 2</option>
                <option value="3">Day 3</option>
              </select>
              <label>Timer</label>
              <select id="timerSel">
                <option value="30">30:00</option>
                <option value="25">25:00</option>
                <option value="35">35:00</option>
                <option value="40">40:00</option>
              </select>
            </div>
            <div class="row" style="margin-top:6px">
              <label>Bells</label>
              <select id="bellsSel">
                <option value="pair">Pair</option>
                <option value="single">Single</option>
              </select>
              <label>Weight (lbs)</label>
              <input
                id="weightLbs"
                type="number"
                min="0"
                step="1"
                placeholder="lbs"
              />
            </div>
          </div>
          <div class="row" style="justify-content:flex-end">
            <button id="resetSession" class="btn danger">Reset Session</button>
          </div>
        </div>
        <div class="grid cols-2" style="margin-top:10px">
          <div class="card" style="padding:10px">
            <div class="timer mono" id="timer">30:00</div>
            <div
              class="row"
              style="justify-content:center; gap:10px; margin-top:6px"
            >
              <button id="startBtn" class="btn accent">Start</button>
              <button id="pauseBtn" class="btn">Pause</button>
              <button id="resetBtn" class="btn">Reset</button>
            </div>
            <div style="text-align:center; margin-top:6px" class="subtle">
              Alternate A1 and A2. Stay fresh; no grinding.
            </div>
          </div>

          <div class="card" style="padding:10px">
            <strong id="schemeTitle">Today</strong>
            <div class="note" id="schemeText" style="margin-top:6px"></div>
            <div class="hr"></div>
            <div id="detailsBox" class="note"></div>
          </div>
        </div>
      </section>

      <section class="card">
        <div class="grid cols-2">
          <div class="grid">
            <div class="exercise current" id="currentBox">
              <div>
                <strong id="currentTitle">Do: Clean + Press (A1)</strong>
                <div class="subtle">
                  Target reps: <span id="currentTarget">—</span>
                </div>
              </div>
              <div class="row">
                <button id="logBtn" class="btn good">Log set</button>
                <span class="pill mono strong" id="progressPill"
                  >0 rounds</span
                >
              </div>
            </div>

            <div class="row">
              <span class="pill mono"
                >A1 C+P: <span id="setsA1Pill">0</span></span
              >
              <span class="pill mono"
                >A2 FSQ: <span id="setsA2Pill">0</span></span
              >
            </div>

            <div class="note">
              Tip: Tap = fresh. Hold = mark “rest more.” The app flips to the
              next exercise automatically.
            </div>
          </div>

          <div class="grid">
            <div class="row" style="justify-content:space-between">
              <strong>Session Log</strong>
              <div class="row">
                <button id="undoBtn" class="btn">Undo</button>
                <button id="saveBtn" class="btn">Save</button>
              </div>
            </div>
            <div id="log" class="log"></div>
          </div>
        </div>
      </section>

      <div class="note" style="text-align:center">
        By Geoff Neupert, CSCS. Train smart.
      </div>
    </div>

    <!-- End-of-session summary sheet -->
    <div id="summarySheet" class="sheet" aria-modal="true" role="dialog">
      <div class="panel">
        <div class="head">
          <strong>Session Summary</strong>
          <button id="summaryCloseBtn" class="btn">Done</button>
        </div>
        <div class="body">
          <div id="summaryText" class="note"></div>
          <div class="summary-grid" style="margin-top:8px">
            <div class="kv">
              <div class="k">Mode</div>
              <div class="v" id="sumMode">—</div>
            </div>
            <div class="kv">
              <div class="k">Progress</div>
              <div class="v" id="sumProgress">—</div>
            </div>
            <div class="kv">
              <div class="k">A1 sets (C+P)</div>
              <div class="v" id="sumA1">—</div>
            </div>
            <div class="kv">
              <div class="k">A2 sets (FSQ)</div>
              <div class="v" id="sumA2">—</div>
            </div>
            <div class="kv">
              <div class="k">Total reps</div>
              <div class="v" id="sumReps">—</div>
            </div>
            <div class="kv">
              <div class="k">Fresh vs Rest</div>
              <div class="v" id="sumFresh">—</div>
            </div>
            <div class="kv">
              <div class="k">Best rung / set size</div>
              <div class="v" id="sumBest">—</div>
            </div>
            <div class="kv">
              <div class="k">Weight / Bells</div>
              <div class="v" id="sumWB">—</div>
            </div>
          </div>
        </div>
        <div class="actions">
          <button id="copySummaryBtn" class="btn">Copy Summary</button>
          <button id="exportCsvBtn" class="btn">Export CSV</button>
          <button id="shareSummaryBtn" class="btn accent">Share</button>
        </div>
      </div>
    </div>

    <div id="toast" class="toast"></div>

    <script>
      ;(() => {
        const $ = (id) => document.getElementById(id)

        const state = {
          running: false,
          endAt: null,
          remaining: 30 * 60 * 1000,
          tickHandle: null,
          nextIsA1: true,
          setsA1: 0,
          setsA2: 0,
          history: [], // {t, ex, reps|null, fresh}
          targetIndex: 0,
          installEvt: null,
          pending5: false, // W4D1 optional 5 pair when both 4s are fresh
          dropTo3: false, // W4D3 auto-drop to 3s after a grindy 4
          ladderCycles: 0 // counts completed ladders only
        }

        const fmtTime = (ms) => {
          const s = Math.max(0, Math.round(ms / 1000))
          const m = Math.floor(s / 60)
          const r = s % 60
          return `${String(m).padStart(2, '0')}:${String(r).padStart(2, '0')}`
        }
        const beep = (freq = 880, ms = 120) => {
          try {
            const actx = new (window.AudioContext ||
              window.webkitAudioContext)()
            const o = actx.createOscillator()
            const g = actx.createGain()
            o.type = 'sine'
            o.frequency.value = freq
            o.connect(g)
            g.connect(actx.destination)
            g.gain.setValueAtTime(0.001, actx.currentTime)
            g.gain.exponentialRampToValueAtTime(0.18, actx.currentTime + 0.01)
            o.start()
            setTimeout(() => {
              g.gain.exponentialRampToValueAtTime(
                0.0001,
                actx.currentTime + 0.02
              )
              o.stop()
              actx.close()
            }, ms)
          } catch {}
        }
        const nowISO = () => new Date().toISOString()

        // Toasts
        let toastTimer = null
        function toast(msg) {
          const t = $('toast')
          t.textContent = msg
          t.classList.add('show')
          clearTimeout(toastTimer)
          toastTimer = setTimeout(() => {
            t.classList.remove('show')
          }, 1800)
        }

        const getWD = () => ({
          w: parseInt($('weekSel').value, 10),
          d: parseInt($('daySel').value, 10)
        })

        function getScheme() {
          const { w, d } = getWD()
          if (w === 1) {
            if (d === 1) return { mode: 'ladders123', text: 'Ladders 1-2-3' }
            if (d === 2) return { mode: 'fixed1', text: 'Sets of 1' }
            return { mode: 'fixed2', text: 'Sets of 2' }
          }
          if (w === 2) {
            if (d === 1) return { mode: 'ladders123', text: 'Ladders 1-2-3' }
            if (d === 2) return { mode: 'fixed1', text: 'Sets of 1' }
            return { mode: 'fixed3', text: 'Sets of 3' }
          }
          if (w === 3) {
            if (d === 1)
              return { mode: 'ladders1234', text: 'Ladders 1-2-3-4' }
            if (d === 2) return { mode: 'fixed2', text: 'Sets of 2' }
            return { mode: 'fixed3', text: 'Sets of 3' }
          }
          if (w === 4) {
            if (d === 1)
              return {
                mode: 'ladders1234opt5',
                text: 'Ladders 1-2-3-4 (+ auto 5 if both 4s are fresh)'
              }
            if (d === 2) return { mode: 'fixed2', text: 'Sets of 2' }
            return {
              mode: 'alt34',
              text: 'Alternate 3 and 4 (auto-drop to 3s if 4s slow)'
            }
          }
          if (d === 1)
            return {
              mode: 'cap3x3',
              text: 'Perform 3×3 (cap at 6 alternating sets)'
            }
          return {
            mode: 'rmtest',
            text: 'Test a new RM (Press). Use the timer if you like.'
          }
        }

        const isLadderMode = (mode) => mode.startsWith('ladders')

        function currentTargetReps() {
          const { mode } = getScheme()
          if (mode === 'rmtest') return 'As tested'
          if (mode === 'cap3x3') return 3
          if (mode === 'ladders123') return [1, 2, 3][state.targetIndex % 3]
          if (mode === 'ladders1234')
            return [1, 2, 3, 4][state.targetIndex % 4]
          if (mode === 'ladders1234opt5') {
            if (state.pending5) return 5
            return [1, 2, 3, 4][state.targetIndex % 4]
          }
          if (mode === 'fixed1') return 1
          if (mode === 'fixed2') return 2
          if (mode === 'fixed3') return 3
          if (mode === 'alt34') {
            if (state.dropTo3) return 3
            return state.targetIndex % 2 === 0 ? 3 : 4
          }
          return '—'
        }

        function updateCurrentBox() {
          const ex = state.nextIsA1 ? 'A1' : 'A2'
          const title = ex === 'A1' ? 'Clean + Press (A1)' : 'Front Squat (A2)'
          $('currentTitle').textContent = `Do: ${title}`
          $('currentTarget').textContent = currentTargetReps()
        }

        // Timer
        function setTimerFromSelect() {
          const mins = parseInt($('timerSel').value, 10)
          state.remaining = mins * 60 * 1000
          $('timer').textContent = fmtTime(state.remaining)
        }
        function startTimer() {
          if (state.running) return
          state.running = true
          state.endAt = Date.now() + state.remaining
          tick()
        }
        function pauseTimer() {
          if (!state.running) return
          state.running = false
          clearTimeout(state.tickHandle)
          state.remaining = Math.max(0, state.endAt - Date.now())
          $('timer').textContent = fmtTime(state.remaining)
        }
        function resetTimer() {
          state.running = false
          clearTimeout(state.tickHandle)
          setTimerFromSelect()
        }
        function tick() {
          const left = state.endAt - Date.now()
          state.remaining = Math.max(0, left)
          $('timer').textContent = fmtTime(left)
          if (left <= 0) {
            state.running = false
            // Distinct end-of-session tones
            beep(330, 200)
            setTimeout(() => beep(660, 200), 60)
            setTimeout(() => beep(880, 240), 120)
            showSummarySheet()
            toast('Time! Session summary ready.')
            return
          }
          state.tickHandle = setTimeout(tick, 200)
        }

        // Details UI
        function buildDetailsHTML() {
          const { w, d } = getWD()
          const { mode, text } = getScheme()
          $('schemeTitle').textContent = `Today: Week ${w}, Day ${d}`
          $('schemeText').textContent = text

          if (mode.startsWith('ladders')) {
            const ladderText =
              mode === 'ladders123'
                ? '1-2-3'
                : mode === 'ladders1234'
                ? '1-2-3-4'
                : '1-2-3-4 (+ optional 5 when fresh)'
            return `
              <div>
                <div><strong>How ladders work:</strong></div>
                <ul>
                  <li>Alternate A1 and A2 with the same rep number.</li>
                  <li>Cycle through ${ladderText}, then restart at 1.</li>
                  ${
                    mode === 'ladders1234opt5'
                      ? '<li>If both 4-rep sets are fresh, one 5-rep pair is added, then the ladder restarts.</li>'
                      : ''
                  }
                  <li>Progress pill shows <em>ladder sets</em> (completed ladders only).</li>
                </ul>
                <div class="mono" style="margin-left:12px">
                  A1×1, A2×1, A1×2, A2×2, A1×3, A2×3 ...
                </div>
              </div>
            `
          }

          if (mode === 'fixed1' || mode === 'fixed2' || mode === 'fixed3') {
            const reps = mode === 'fixed1' ? 1 : mode === 'fixed2' ? 2 : 3
            return `
              <ul>
                <li>Perform crisp sets of ${reps} reps.</li>
                <li>Alternate A1 and A2 for the entire timer.</li>
                <li>Progress pill shows <em>rounds</em> (completed A1+A2 pairs).</li>
              </ul>
            `
          }

          if (mode === 'alt34') {
            return `
              <ul>
                <li>Alternate 3 and 4 reps: A1×3, A2×3, A1×4, A2×4, repeat.</li>
                <li>If a 4 slows, hold on log; the app drops to 3s.</li>
                <li>Progress pill shows <em>rounds</em> (completed A1+A2 pairs).</li>
              </ul>
            `
          }

          if (mode === 'cap3x3') {
            return `
              <ul>
                <li>Perform 3×3 for each exercise, alternating (total 6 sets).</li>
                <li>App caps logging at 6 sets. Progress pill shows rounds.</li>
              </ul>
            `
          }

          if (mode === 'rmtest') {
            return `
              <ul>
                <li>Warm up, then test a new rep max for the Press.</li>
                <li>Use the weight (lbs) field for reference. Log attempts.</li>
                <li>Progress pill shows rounds if you alternate both lifts.</li>
              </ul>
            `
          }

          return ''
        }

        function updateDetails() {
          $('detailsBox').innerHTML = buildDetailsHTML()
        }

        // Log rendering helpers
        function renderLogItem(h) {
          const row = document.createElement('div')
          row.className = 'log-item'
          const when = new Date(h.t)
          const side = document.createElement('div')
          side.className = 'pill mono'
          side.textContent = h.ex === 'A1' ? 'A1 C+P' : 'A2 FSQ'
          const main = document.createElement('div')
          main.innerHTML = `<div class="mono">${
            h.reps != null ? `${h.reps} reps` : '—'
          }</div>
          <div class="subtle">${when.toLocaleTimeString()}</div>`
          const r = document.createElement('div')
          r.className = 'pill'
          r.textContent = h.fresh ? 'fresh' : 'rest more'
          row.appendChild(side)
          row.appendChild(main)
          row.appendChild(r)
          return row
        }

        function renderLog() {
          const el = $('log')
          el.innerHTML = ''
          state.history.forEach((h) => {
            const item = renderLogItem(h)
            el.appendChild(item)
          })
        }

        function appendLastLogAnimated() {
          const el = $('log')
          const h = state.history[state.history.length - 1]
          if (!h) return
          const item = renderLogItem(h)
          item.classList.add('anim-in')
          el.appendChild(item)
        }

        // Stats and progress pill
        function pulseProgress() {
          const p = $('progressPill')
          p.classList.remove('pulse')
          // Force reflow so animation can replay
          void p.offsetWidth
          p.classList.add('pulse')
        }

        function renderStats() {
          $('setsA1Pill').textContent = state.setsA1
          $('setsA2Pill').textContent = state.setsA2
          const { mode } = getScheme()
          const pairs = Math.min(state.setsA1, state.setsA2)
          if (isLadderMode(mode)) {
            $('progressPill').textContent = `${state.ladderCycles} ladder set${
              state.ladderCycles === 1 ? '' : 's'
            }`
          } else {
            $('progressPill').textContent = `${pairs} round${
              pairs === 1 ? '' : 's'
            }`
          }
        }

        function capReachedIfAny() {
          const { mode } = getScheme()
          if (mode === 'cap3x3') {
            return state.history.length >= 6
          }
          return false
        }

        // Core logging (tap= fresh, hold= rest more)
        function logSetInternal(ex, fresh) {
          if (capReachedIfAny()) {
            toast('Cap reached (Week 5 Day 1: 3×3 total).')
            return
          }
          const reps = currentTargetReps()
          const wasSecond = !state.nextIsA1

          const entry = {
            t: nowISO(),
            ex,
            reps: typeof reps === 'number' ? reps : null,
            fresh
          }
          state.history.push(entry)
          if (ex === 'A1') state.setsA1++
          if (ex === 'A2') state.setsA2++

          const { mode } = getScheme()

          // W4D3: auto drop to 3s if a 4 is not fresh
          if (mode === 'alt34' && entry.reps === 4 && !fresh) {
            if (!state.dropTo3) toast('Dropping to 3s for the rest of today.')
            state.dropTo3 = true
          }

          let justCompletedLadder = false

          // After each pair, advance and possibly count ladder cycles
          if (wasSecond) {
            if (mode === 'ladders1234opt5') {
              const n = state.history.length
              const prev = state.history[n - 2]
              let cycleDone = false

              if (state.pending5 && entry.reps === 5) {
                // Completed optional 5s pair -> full ladder done
                state.pending5 = false
                state.targetIndex = 0
                cycleDone = true
              } else if (entry.reps === 4 && prev && prev.reps === 4) {
                // Finished the 4s pair; decide on optional 5s
                if (prev.fresh && entry.fresh) {
                  state.pending5 = true // add a 5-rep pair before restarting
                  toast('Adding an optional 5-rep pair.')
                } else {
                  state.targetIndex++
                  cycleDone = true // no 5s, so ladder completes at 4
                }
              } else {
                state.targetIndex++
              }

              if (cycleDone) {
                state.ladderCycles++
                justCompletedLadder = true
              }
            } else if (mode === 'ladders123') {
              state.targetIndex++
              if (entry.reps === 3) {
                state.ladderCycles++
                justCompletedLadder = true
              }
            } else if (mode === 'ladders1234') {
              state.targetIndex++
              if (entry.reps === 4) {
                state.ladderCycles++
                justCompletedLadder = true
              }
            } else {
              // Non-ladders
              state.targetIndex++
            }
          }

          // Flip to the other exercise
          state.nextIsA1 = !state.nextIsA1

          // UI updates
          updateCurrentBox()
          renderStats()
          appendLastLogAnimated()
          beep(740, 100)
          toast(
            `${ex} ${typeof entry.reps === 'number' ? '×' + entry.reps : ''} ${
              fresh ? '(fresh)' : '(rest more)'
            }`
          )
          if (justCompletedLadder) {
            pulseProgress()
          }
        }

        // Recompute from full history (for undo/scheme switch)
        function recomputeFromHistory() {
          const { mode } = getScheme()
          state.setsA1 = 0
          state.setsA2 = 0
          state.targetIndex = 0
          state.pending5 = false
          state.dropTo3 = false
          state.nextIsA1 = true
          state.ladderCycles = 0

          for (let i = 0; i < state.history.length; i++) {
            const h = state.history[i]
            const wasSecond = !state.nextIsA1
            if (h.ex === 'A1') state.setsA1++
            if (h.ex === 'A2') state.setsA2++

            if (mode === 'alt34' && h.reps === 4 && h.fresh === false) {
              state.dropTo3 = true
            }

            if (wasSecond) {
              if (mode === 'ladders1234opt5') {
                const prev = state.history[i - 1]
                let cycleDone = false

                if (state.pending5 && h.reps === 5) {
                  state.pending5 = false
                  state.targetIndex = 0
                  cycleDone = true
                } else if (h.reps === 4 && prev && prev.reps === 4) {
                  if (prev.fresh && h.fresh) {
                    state.pending5 = true
                  } else {
                    state.targetIndex++
                    cycleDone = true
                  }
                } else {
                  state.targetIndex++
                }

                if (cycleDone) state.ladderCycles++
              } else if (mode === 'ladders123') {
                state.targetIndex++
                if (h.reps === 3) state.ladderCycles++
              } else if (mode === 'ladders1234') {
                state.targetIndex++
                if (h.reps === 4) state.ladderCycles++
              } else {
                state.targetIndex++
              }
            }
            state.nextIsA1 = !state.nextIsA1
          }

          updateCurrentBox()
          renderStats()
          renderLog()
        }

        // One-button logging (tap/hold)
        function setupLogButton() {
          const btn = $('logBtn')
          let holdTimer = null
          let didHold = false
          function clearHold() {
            clearTimeout(holdTimer)
            holdTimer = null
          }
          btn.addEventListener('pointerdown', (e) => {
            e.preventDefault()
            didHold = false
            holdTimer = setTimeout(() => {
              didHold = true
              const ex = state.nextIsA1 ? 'A1' : 'A2'
              logSetInternal(ex, false) // rest more
            }, 420)
          })
          btn.addEventListener('pointerup', (e) => {
            e.preventDefault()
            if (holdTimer) {
              clearHold()
              if (!didHold) {
                const ex = state.nextIsA1 ? 'A1' : 'A2'
                logSetInternal(ex, true) // fresh
              }
            }
          })
          btn.addEventListener('pointerleave', clearHold)
          btn.addEventListener('pointercancel', clearHold)
        }

        function undo() {
          state.history.pop()
          recomputeFromHistory()
        }

        function resetSession() {
          if (!confirm('Reset current session (timer, sets, log)?')) return
          pauseTimer()
          state.remaining = parseInt($('timerSel').value, 10) * 60 * 1000
          $('timer').textContent = fmtTime(state.remaining)
          state.setsA1 = 0
          state.setsA2 = 0
          state.history = []
          state.targetIndex = 0
          state.nextIsA1 = true
          state.pending5 = false
          state.dropTo3 = false
          state.ladderCycles = 0
          updateCurrentBox()
          renderStats()
          renderLog()
          toast('Session reset.')
        }

        // Summary building
        function computeSummary() {
          const { mode, text } = getScheme()
          const ladderMode = isLadderMode(mode)
          const pairs = Math.min(state.setsA1, state.setsA2)
          const totalReps = state.history.reduce(
            (sum, h) => sum + (typeof h.reps === 'number' ? h.reps : 0),
            0
          )
          const freshCount = state.history.filter((h) => h.fresh).length
          const restCount = state.history.length - freshCount
          const bestReps = state.history.reduce((m, h) => {
            if (typeof h.reps === 'number') return Math.max(m, h.reps)
            return m
          }, 0)
          const weight = parseFloat($('weightLbs').value || '0')
          const bells = $('bellsSel').value

          return {
            modeText: text,
            ladderMode,
            progressText: ladderMode
              ? `${state.ladderCycles} ladder set${
                  state.ladderCycles === 1 ? '' : 's'
                }`
              : `${pairs} round${pairs === 1 ? '' : 's'}`,
            setsA1: state.setsA1,
            setsA2: state.setsA2,
            totalReps,
            freshCount,
            restCount,
            best: bestReps || '—',
            weight,
            bells,
            week: $('weekSel').value,
            day: $('daySel').value,
            timerMin: $('timerSel').value
          }
        }

        function buildSummaryText(s) {
          const lines = [
            `Simple Strength — Week ${s.week}, Day ${s.day}`,
            `Mode: ${s.modeText}`,
            `Progress: ${s.progressText}`,
            `Sets — A1(C+P): ${s.setsA1}, A2(FSQ): ${s.setsA2}`,
            `Total reps: ${s.totalReps}`,
            `Fresh vs Rest: ${s.freshCount} / ${s.restCount}`,
            `${s.ladderMode ? 'Best rung' : 'Best set size'}: ${s.best}`,
            `Weight/Bells: ${s.weight || 0} lbs (${s.bells})`,
            `Timer: ${s.timerMin} min`,
            `Logged sets: ${state.history.length}`
          ]
          return lines.join('\n')
        }

        function buildCSV() {
          const header = [
            'timestamp',
            'exercise',
            'reps',
            'fresh',
            'week',
            'day',
            'bells',
            'weight_lbs',
            'timer_min'
          ]
          const s = computeSummary()
          const rows = state.history.map((h) => [
            h.t,
            h.ex,
            typeof h.reps === 'number' ? h.reps : '',
            h.fresh ? 'fresh' : 'rest',
            s.week,
            s.day,
            s.bells,
            s.weight,
            s.timerMin
          ])
          return [header, ...rows]
            .map((r) => r.map((v) => `"${String(v).replace(/"/g, '""')}"`).join(','))
            .join('\n')
        }

        function showSummarySheet() {
          const s = computeSummary()
          $('sumMode').textContent = s.modeText
          $('sumProgress').textContent = s.progressText
          $('sumA1').textContent = s.setsA1
          $('sumA2').textContent = s.setsA2
          $('sumReps').textContent = s.totalReps
          $('sumFresh').textContent = `${s.freshCount} / ${s.restCount}`
          $('sumBest').textContent = s.best
          $('sumWB').textContent = `${s.weight || 0} lbs (${s.bells})`
          $('summaryText').textContent = `Week ${s.week}, Day ${s.day} — ${
            s.modeText
          }`

          const sheet = $('summarySheet')
          sheet.classList.add('show')
        }
        function hideSummarySheet() {
          $('summarySheet').classList.remove('show')
        }

        function downloadCSV(csvText) {
          const blob = new Blob([csvText], { type: 'text/csv' })
          const url = URL.createObjectURL(blob)
          const a = document.createElement('a')
          const ts = new Date()
            .toISOString()
            .replace(/[-:]/g, '')
            .replace(/\..+/, '')
          a.href = url
          a.download = `simple-strength-${ts}.csv`
          document.body.appendChild(a)
          a.click()
          a.remove()
          setTimeout(() => URL.revokeObjectURL(url), 1000)
        }

        // Save
        function saveSession() {
          const key = 'simple-strength-log'
          const data = JSON.parse(localStorage.getItem(key) || '[]')
          const { mode } = getScheme()
          const pairs = Math.min(state.setsA1, state.setsA2)
          data.push({
            savedAt: nowISO(),
            week: parseInt($('weekSel').value, 10),
            day: parseInt($('daySel').value, 10),
            bells: $('bellsSel').value,
            weightLbs: parseFloat($('weightLbs').value || '0'),
            timerMin: parseInt($('timerSel').value, 10),
            metric: isLadderMode(mode)
              ? 'ladderSets:' + state.ladderCycles
              : 'rounds:' + pairs,
            history: state.history
          })
          localStorage.setItem(key, JSON.stringify(data))
          toast('Session saved locally.')
        }

        // Wire-up
        $('startBtn').addEventListener('click', startTimer)
        $('pauseBtn').addEventListener('click', pauseTimer)
        $('resetBtn').addEventListener('click', resetTimer)
        $('resetSession').addEventListener('click', resetSession)
        $('undoBtn').addEventListener('click', undo)
        $('saveBtn').addEventListener('click', saveSession)
        setupLogButton()

        ;['weekSel', 'daySel'].forEach((id) =>
          $(id).addEventListener('change', () => {
            // Recompute state against the selected scheme
            updateDetails()
            recomputeFromHistory()
          })
        )
        $('timerSel').addEventListener('change', setTimerFromSelect)

        // Summary actions
        $('summaryCloseBtn').addEventListener('click', hideSummarySheet)
        $('summarySheet').addEventListener('click', (e) => {
          if (e.target === $('summarySheet')) hideSummarySheet()
        })
        $('copySummaryBtn').addEventListener('click', async () => {
          const s = computeSummary()
          const text = buildSummaryText(s)
          try {
            await navigator.clipboard.writeText(text)
            toast('Summary copied to clipboard.')
          } catch {
            toast('Copy failed. Long-press to select text.')
          }
        })
        $('exportCsvBtn').addEventListener('click', () => {
          const csv = buildCSV()
          downloadCSV(csv)
        })
        $('shareSummaryBtn').addEventListener('click', async () => {
          const s = computeSummary()
          const text = buildSummaryText(s)
          if (navigator.share) {
            try {
              await navigator.share({ text, title: 'Simple Strength Summary' })
            } catch {}
          } else {
            try {
              await navigator.clipboard.writeText(text)
              toast('Copied summary (no Share available).')
            } catch {
              toast('Share not available. Try Export CSV.')
            }
          }
        })

        // Prefs
        function loadPrefs() {
          const k = 'simple-strength-prefs'
          const p = JSON.parse(localStorage.getItem(k) || '{}')
          if (p.week) $('weekSel').value = p.week
          if (p.day) $('daySel').value = p.day
          if (p.timer) $('timerSel').value = p.timer
          if (p.bells) $('bellsSel').value = p.bells
          if (p.weightLbs != null) $('weightLbs').value = p.weightLbs
        }
        function savePrefs() {
          const k = 'simple-strength-prefs'
          const p = {
            week: $('weekSel').value,
            day: $('daySel').value,
            timer: $('timerSel').value,
            bells: $('bellsSel').value,
            weightLbs: $('weightLbs').value
          }
          localStorage.setItem(k, JSON.stringify(p))
        }
        ;['weekSel', 'daySel', 'timerSel', 'bellsSel', 'weightLbs'].forEach(
          (id) => $(id).addEventListener('change', savePrefs)
        )

        // Init
        loadPrefs()
        setTimerFromSelect()
        updateDetails()
        recomputeFromHistory()

        // PWA manifest + SW
        async function buildIcons() {
          function draw(size) {
            const c = document.createElement('canvas')
            c.width = size
            c.height = size
            const ctx = c.getContext('2d')
            ctx.fillStyle = '#111827'
            ctx.fillRect(0, 0, size, size)
            ctx.fillStyle = '#f59e0b'
            const r = size * 0.34
            ctx.beginPath()
            ctx.ellipse(size / 2, size * 0.56, r, r * 0.75, 0, 0, Math.PI * 2)
            ctx.fill()
            ctx.fillRect(size * 0.25, size * 0.54, size * 0.5, size * 0.28)
            ctx.beginPath()
            ctx.lineWidth = size * 0.08
            ctx.strokeStyle = '#f59e0b'
            ctx.arc(size / 2, size * 0.34, size * 0.22, Math.PI, 0)
            ctx.stroke()
            return c.toDataURL('image/png')
          }
          return [
            { src: draw(192), sizes: '192x192', type: 'image/png' },
            {
              src: draw(512),
              sizes: '512x512',
              type: 'image/png',
              purpose: 'any maskable'
            }
          ]
        }

        async function setupManifest() {
          const icons = await buildIcons()
          const manifest = {
            name: 'Simple Strength Program',
            short_name: 'Strength',
            description:
              'Clean + Press and Front Squat alternating sets — ladders and fixed reps with autoregulation. Offline-ready.',
            start_url: '.',
            display: 'standalone',
            background_color: '#111827',
            theme_color: '#111827',
            icons
          }
          const blob = new Blob([JSON.stringify(manifest)], {
            type: 'application/json'
          })
          const url = URL.createObjectURL(blob)
          const link = document.createElement('link')
          link.rel = 'manifest'
          link.href = url
          document.head.appendChild(link)
        }

        async function setupSW() {
          if (!('serviceWorker' in navigator)) return
          const swCode = `
            const CACHE = "simple-strength-v1";
            self.addEventListener("install", (e) => {
              e.waitUntil(
                caches.open(CACHE).then((c) =>
                  c.addAll([self.registration.scope || "./"])
                )
              );
              self.skipWaiting();
            });
            self.addEventListener("activate", (e) => {
              e.waitUntil(
                caches.keys().then((keys) =>
                  Promise.all(
                    keys.filter((k) => k !== CACHE).map((k) => caches.delete(k))
                  )
                )
              );
              self.clients.claim();
            });
            self.addEventListener("fetch", (e) => {
              const req = e.request;
              if (req.method !== "GET") return;
              e.respondWith(
                caches.match(req).then((hit) =>
                  hit ||
                  fetch(req)
                    .then((res) => {
                      const copy = res.clone();
                      caches.open(CACHE).then((c) => c.put(req, copy));
                      return res;
                    })
                    .catch(() => caches.match(self.registration.scope || "./"))
                )
              );
            });
          `
          const blob = new Blob([swCode], { type: 'text/javascript' })
          const url = URL.createObjectURL(blob)
          try {
            await navigator.serviceWorker.register(url)
          } catch (e) {
            console.warn('SW registration failed', e)
          }
        }

        // Install prompt (Chromium)
        window.addEventListener('beforeinstallprompt', (e) => {
          e.preventDefault()
          state.installEvt = e
          $('installBtn').disabled = false
        })
        $('installBtn').addEventListener('click', async () => {
          if (state.installEvt) {
            try {
              state.installEvt.prompt()
              await state.installEvt.userChoice
            } finally {
              state.installEvt = null
            }
          } else {
            toast('Use your browser menu to Add to Home Screen.')
          }
        })

        setupManifest()
        setupSW()

        // Native-like zoom guards (iOS/Safari)
        // This intentionally disables page zoom (pinch, double-tap).
        // Remove if you need accessibility zoom.
        try {
          document.addEventListener(
            'gesturestart',
            (e) => e.preventDefault(),
            { passive: false }
          )
          document.addEventListener(
            'gesturechange',
            (e) => e.preventDefault(),
            { passive: false }
          )
          document.addEventListener(
            'dblclick',
            (e) => e.preventDefault(),
            { passive: false }
          )
        } catch {}
      })()
    </script>
  </body>
</html>
