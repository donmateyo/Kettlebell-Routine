<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>Cardio Sync</title>

<!-- PWA Meta Tags -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Cardio Sync">
<meta name="mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#0a0a0f">

<!-- SVG Favicon -->
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 180 180'%3E%3Cdefs%3E%3ClinearGradient id='bg' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' stop-color='%231a1a2e'/%3E%3Cstop offset='100%25' stop-color='%230a0a0f'/%3E%3C/linearGradient%3E%3ClinearGradient id='pulse' x1='0%25' y1='0%25' x2='100%25' y2='0%25'%3E%3Cstop offset='0%25' stop-color='%236366f1'/%3E%3Cstop offset='100%25' stop-color='%2322d3ee'/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='180' height='180' rx='40' fill='url(%23bg)'/%3E%3Cpath d='M25 95 L50 95 L60 70 L75 120 L90 50 L105 130 L120 80 L130 95 L155 95' stroke='url(%23pulse)' stroke-width='8' stroke-linecap='round' stroke-linejoin='round' fill='none'/%3E%3C/svg%3E">

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&family=JetBrains+Mono:wght@500;600;700&display=swap" rel="stylesheet">

<style>
:root {
    --bg: #0a0a0f;
    --surface: #12121a;
    --surface-hover: #18182a;
    --surface-elevated: #1e1e2e;
    --border: rgba(255, 255, 255, 0.08);
    --border-light: rgba(255, 255, 255, 0.12);
    --border-accent: rgba(99, 102, 241, 0.4);
    
    --primary: #6366f1;
    --primary-light: #818cf8;
    --primary-glow: rgba(99, 102, 241, 0.35);
    --primary-dim: rgba(99, 102, 241, 0.15);
    
    --accent: #22d3ee;
    --accent-dim: rgba(34, 211, 238, 0.15);
    
    --success: #10b981;
    --success-dim: rgba(16, 185, 129, 0.15);
    --danger: #ef4444;
    --danger-dim: rgba(239, 68, 68, 0.15);
    
    --text: #ffffff;
    --text-secondary: #a1a1aa;
    --text-muted: #71717a;
    
    --radius-sm: 12px;
    --radius-md: 16px;
    --radius-lg: 22px;
    --radius-xl: 28px;
    
    --safe-top: env(safe-area-inset-top, 20px);
    --safe-bottom: env(safe-area-inset-bottom, 20px);
}

* {
    box-sizing: border-box;
    -webkit-tap-highlight-color: transparent;
    -webkit-font-smoothing: antialiased;
}

html, body {
    margin: 0;
    padding: 0;
    height: 100%;
}

body {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    color: var(--text);
    background: var(--bg);
    display: flex;
    flex-direction: column;
    min-height: 100vh;
    min-height: -webkit-fill-available;
    overflow: hidden;
}

.view {
    flex: 1;
    display: none;
    flex-direction: column;
    padding: 20px;
    padding-top: calc(var(--safe-top) + 12px);
    padding-bottom: calc(90px + var(--safe-bottom));
    overflow-y: auto;
    overflow-x: hidden;
    -webkit-overflow-scrolling: touch;
}

.view.active {
    display: flex;
}

.view::-webkit-scrollbar {
    display: none;
}

.page-header {
    margin-bottom: 24px;
}

.page-header-row {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 16px;
}

.page-title {
    font-size: 32px;
    font-weight: 800;
    letter-spacing: -0.5px;
    margin: 0 0 4px;
    color: var(--text);
}

.page-subtitle {
    font-size: 12px;
    font-weight: 600;
    letter-spacing: 1px;
    color: var(--text-muted);
    text-transform: uppercase;
    margin: 0;
}

.card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius-lg);
    padding: 20px;
    margin-bottom: 16px;
    position: relative;
}

.card-glow {
    border-color: var(--border-accent);
    background: linear-gradient(135deg, rgba(99, 102, 241, 0.08) 0%, var(--surface) 100%);
}

.card-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 12px;
    gap: 12px;
}

.card-icon {
    width: 48px;
    height: 48px;
    border-radius: var(--radius-md);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 22px;
    background: var(--primary-dim);
    flex-shrink: 0;
}

.card-icon.accent {
    background: var(--accent-dim);
}

.card-icon.danger {
    background: var(--danger-dim);
}

.card-title {
    font-size: 20px;
    font-weight: 700;
    letter-spacing: -0.3px;
    margin: 0 0 4px;
}

.card-desc {
    color: var(--text-secondary);
    font-size: 14px;
    line-height: 1.5;
    margin: 0 0 16px;
}

.tags {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-bottom: 16px;
}

.tag {
    display: inline-flex;
    align-items: center;
    padding: 6px 12px;
    border-radius: 100px;
    font-size: 11px;
    font-weight: 600;
    letter-spacing: 0.3px;
    background: var(--surface-elevated);
    color: var(--text-secondary);
    border: 1px solid var(--border);
}

.tag.primary {
    background: var(--primary-dim);
    color: var(--primary-light);
    border-color: rgba(99, 102, 241, 0.3);
}

.tag.danger {
    background: var(--danger-dim);
    color: var(--danger);
    border-color: rgba(239, 68, 68, 0.3);
}

.btn-primary {
    width: 100%;
    padding: 16px 24px;
    border-radius: var(--radius-md);
    border: none;
    font-weight: 700;
    font-size: 15px;
    cursor: pointer;
    background: var(--primary);
    color: white;
    box-shadow: 0 4px 20px var(--primary-glow);
    -webkit-appearance: none;
    appearance: none;
}

.btn-primary:active {
    opacity: 0.9;
    transform: scale(0.98);
}

.btn-secondary {
    width: 100%;
    padding: 16px 24px;
    border-radius: var(--radius-md);
    border: 1px solid var(--border-light);
    font-weight: 600;
    font-size: 15px;
    cursor: pointer;
    background: var(--surface-elevated);
    color: var(--text);
    -webkit-appearance: none;
    appearance: none;
}

.btn-secondary:active {
    background: var(--surface-hover);
}

.btn-icon {
    width: 44px;
    height: 44px;
    border-radius: var(--radius-md);
    border: 1px solid var(--border-light);
    background: var(--surface);
    color: var(--text);
    font-size: 18px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    -webkit-appearance: none;
    appearance: none;
}

.btn-icon:active {
    background: var(--surface-hover);
}

.btn-icon.danger {
    color: var(--danger);
    border-color: rgba(239, 68, 68, 0.4);
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 12px;
    margin-bottom: 24px;
}

.stat-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius-md);
    padding: 18px 12px;
    text-align: center;
}

.stat-value {
    font-size: 28px;
    font-family: 'JetBrains Mono', monospace;
    font-weight: 700;
    color: var(--text);
    margin-bottom: 4px;
}

.stat-label {
    font-size: 10px;
    font-weight: 700;
    letter-spacing: 1px;
    color: var(--text-muted);
    text-transform: uppercase;
}

.section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
    margin-top: 8px;
}

.section-title {
    font-size: 12px;
    font-weight: 700;
    letter-spacing: 1px;
    color: var(--text-muted);
    text-transform: uppercase;
    margin: 0;
}

.section-link {
    font-size: 13px;
    font-weight: 600;
    color: var(--primary-light);
    background: none;
    border: none;
    cursor: pointer;
    padding: 0;
    -webkit-appearance: none;
    appearance: none;
}

.history-panel {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius-md);
    margin-bottom: 12px;
    overflow: hidden;
}

.history-panel summary {
    list-style: none;
    padding: 16px;
    cursor: pointer;
    display: flex;
    align-items: center;
}

.history-panel summary::-webkit-details-marker {
    display: none;
}

.history-summary {
    display: flex;
    width: 100%;
    justify-content: space-between;
    align-items: center;
    gap: 12px;
}

.history-info {
    flex: 1;
    min-width: 0;
}

.history-title {
    font-size: 15px;
    font-weight: 700;
    margin-bottom: 4px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.history-meta {
    font-size: 12px;
    color: var(--text-muted);
    display: flex;
    gap: 6px;
}

.history-duration {
    font-family: 'JetBrains Mono', monospace;
    font-size: 14px;
    font-weight: 600;
    color: var(--primary-light);
    flex-shrink: 0;
}

.history-detail {
    padding: 16px;
    border-top: 1px solid var(--border);
    background: rgba(0, 0, 0, 0.2);
}

.exercise-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
    gap: 10px;
    margin-bottom: 16px;
}

.exercise-chip {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    padding: 12px;
}

.exercise-name {
    font-size: 13px;
    font-weight: 600;
    margin-bottom: 4px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.exercise-meta {
    font-size: 11px;
    color: var(--text-muted);
}

.history-actions {
    display: flex;
    gap: 10px;
    justify-content: flex-end;
}

.history-notes {
    font-style: italic;
    color: var(--text-secondary);
    font-size: 13px;
    margin-bottom: 16px;
    padding: 12px;
    background: var(--surface);
    border-radius: var(--radius-sm);
    border-left: 3px solid var(--primary);
}

.empty-state {
    text-align: center;
    padding: 40px 20px;
    color: var(--text-muted);
}

.empty-icon {
    font-size: 40px;
    margin-bottom: 12px;
    opacity: 0.5;
}

.empty-text {
    font-size: 14px;
    line-height: 1.5;
}

.install-status {
    font-size: 12px;
    font-weight: 600;
    color: var(--text-secondary);
    margin-bottom: 12px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.install-status::before {
    content: '';
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: var(--primary);
}

.install-steps {
    list-style: none;
    margin: 0 0 16px;
    padding: 0;
    display: none;
}

.install-steps.show {
    display: block;
}

.install-step {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    padding: 12px 0;
    border-bottom: 1px solid var(--border);
}

.install-step:last-child {
    border-bottom: none;
}

.step-number {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    background: var(--primary-dim);
    color: var(--primary-light);
    font-size: 12px;
    font-weight: 700;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
}

.step-text {
    font-size: 13px;
    color: var(--text-secondary);
    line-height: 1.5;
}

.mini-stats {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius-md);
    overflow: hidden;
}

.mini-stat-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 14px 16px;
    border-bottom: 1px solid var(--border);
    font-size: 13px;
}

.mini-stat-row:last-child {
    border-bottom: none;
}

.mini-stat-date {
    color: var(--text-muted);
    font-size: 12px;
    flex-shrink: 0;
}

.mini-stat-type {
    color: var(--text);
    font-weight: 600;
    flex: 1;
    text-align: center;
    padding: 0 12px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.mini-stat-duration {
    font-family: 'JetBrains Mono', monospace;
    color: var(--primary-light);
    font-weight: 600;
    flex-shrink: 0;
}

.empty-summary {
    text-align: center;
    font-size: 13px;
    color: var(--text-muted);
    padding: 20px;
    background: var(--surface);
    border-radius: var(--radius-sm);
    border: 1px dashed var(--border);
}

#view-timer {
    position: fixed;
    inset: 0;
    background: var(--bg);
    z-index: 500;
    padding: 0;
}

#view-timer.active {
    display: flex !important;
}

.timer-layout {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    position: relative;
    padding: 20px;
}

.timer-header {
    position: absolute;
    top: var(--safe-top);
    left: 0;
    width: 100%;
    padding: 16px 20px;
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
}

.timer-info {
    display: flex;
    flex-direction: column;
    gap: 4px;
}

.timer-round {
    font-size: 12px;
    font-weight: 700;
    letter-spacing: 1.5px;
    color: var(--text);
}

.timer-next {
    font-size: 11px;
    font-weight: 600;
    color: var(--text-muted);
}

.timer-header-right {
    display: flex;
    align-items: center;
    gap: 12px;
}

.workout-elapsed {
    font-family: 'JetBrains Mono', monospace;
    font-size: 14px;
    font-weight: 600;
    color: var(--text-muted);
    background: var(--surface);
    padding: 8px 12px;
    border-radius: var(--radius-sm);
    border: 1px solid var(--border);
}

.circle-wrap {
    position: relative;
    width: min(260px, 65vw);
    height: min(260px, 65vw);
    margin-bottom: 28px;
}

.circle-svg {
    width: 100%;
    height: 100%;
    transform: rotate(-90deg);
}

.circle-bg {
    fill: none;
    stroke: var(--surface-elevated);
    stroke-width: 10;
}

.circle-fg {
    fill: none;
    stroke: url(#timer-gradient);
    stroke-width: 10;
    stroke-linecap: round;
    stroke-dasharray: 842;
    stroke-dashoffset: 0;
    transition: stroke-dashoffset 1s linear;
}

.timer-center {
    position: absolute;
    inset: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
}

.timer-value {
    font-size: clamp(44px, 11vw, 58px);
    font-weight: 700;
    font-family: 'JetBrains Mono', monospace;
    letter-spacing: -2px;
}

.timer-phase {
    font-size: 11px;
    letter-spacing: 3px;
    font-weight: 700;
    color: var(--primary-light);
    margin-top: 6px;
}

.exercise-info {
    text-align: center;
    width: 100%;
    max-width: 340px;
    margin-bottom: 28px;
    padding: 0 16px;
}

.exercise-title {
    font-size: 22px;
    font-weight: 800;
    margin: 0 0 8px;
    letter-spacing: -0.3px;
}

.exercise-details {
    display: flex;
    justify-content: center;
    gap: 16px;
    color: var(--text-secondary);
    font-size: 14px;
    font-weight: 500;
    margin-bottom: 14px;
}

.editable {
    color: var(--primary-light);
    cursor: pointer;
    text-decoration: underline;
    text-decoration-style: dashed;
    text-underline-offset: 3px;
}

.exercise-note {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius-md);
    padding: 14px;
    font-size: 14px;
    color: var(--text-secondary);
    line-height: 1.5;
}

.timer-controls {
    position: absolute;
    bottom: calc(var(--safe-bottom) + 28px);
    display: flex;
    gap: 20px;
}

.control-btn {
    width: 56px;
    height: 56px;
    border-radius: 50%;
    border: 1px solid var(--border-light);
    background: var(--surface);
    color: var(--text);
    font-size: 16px;
    font-weight: 700;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    -webkit-appearance: none;
    appearance: none;
}

.control-btn:active {
    background: var(--surface-hover);
}

.control-btn.primary {
    background: var(--primary);
    border-color: var(--primary);
    color: white;
    box-shadow: 0 4px 16px var(--primary-glow);
}

.control-btn svg {
    width: 20px;
    height: 20px;
    fill: currentColor;
}

nav {
    position: fixed;
    bottom: 0;
    left: 0;
    width: 100%;
    height: calc(70px + var(--safe-bottom));
    background: rgba(12, 12, 18, 0.95);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border-top: 1px solid var(--border);
    display: flex;
    justify-content: space-around;
    align-items: flex-start;
    padding-top: 12px;
    padding-bottom: var(--safe-bottom);
    z-index: 300;
}

.nav-btn {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
    color: var(--text-muted);
    cursor: pointer;
    padding: 4px;
    background: none;
    border: none;
    -webkit-appearance: none;
    appearance: none;
}

.nav-btn.active {
    color: var(--primary-light);
}

.nav-btn svg {
    width: 24px;
    height: 24px;
    fill: currentColor;
}

.nav-btn:active svg {
    transform: scale(0.9);
}

.nav-label {
    font-size: 10px;
    font-weight: 700;
    letter-spacing: 0.5px;
}

.modal {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.8);
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
    display: none;
    align-items: center;
    justify-content: center;
    padding: 20px;
    z-index: 900;
}

.modal.open {
    display: flex;
}

.modal-card {
    width: 100%;
    max-width: 340px;
    background: var(--surface-elevated);
    border: 1px solid var(--border-light);
    border-radius: var(--radius-xl);
    padding: 24px;
    max-height: 85vh;
    overflow-y: auto;
}

.modal-title {
    font-size: 20px;
    font-weight: 800;
    margin: 0 0 20px;
}

.modal-card label {
    font-size: 12px;
    font-weight: 600;
    color: var(--text-muted);
    display: block;
    margin: 16px 0 8px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.modal-card label:first-of-type {
    margin-top: 0;
}

.modal-card input,
.modal-card select,
.modal-card textarea {
    width: 100%;
    border-radius: var(--radius-md);
    border: 1px solid var(--border-light);
    background: var(--surface);
    color: var(--text);
    padding: 14px 16px;
    font-size: 15px;
    -webkit-appearance: none;
    appearance: none;
}

.modal-card input:focus,
.modal-card select:focus,
.modal-card textarea:focus {
    outline: none;
    border-color: var(--primary);
}

.modal-card textarea {
    resize: vertical;
    min-height: 80px;
}

.modal-actions {
    display: flex;
    gap: 12px;
    margin-top: 24px;
}

.modal-btn {
    flex: 1;
    padding: 14px 20px;
    border-radius: var(--radius-md);
    border: none;
    font-weight: 700;
    font-size: 14px;
    cursor: pointer;
    -webkit-appearance: none;
    appearance: none;
}

.modal-btn:active {
    opacity: 0.9;
}

.modal-btn-cancel {
    background: var(--surface);
    color: var(--text-secondary);
    border: 1px solid var(--border-light);
}

.modal-btn-primary {
    background: var(--primary);
    color: white;
}

.modal-btn-danger {
    background: var(--danger);
    color: white;
}

.completion-screen {
    position: fixed;
    inset: 0;
    background: var(--bg);
    z-index: 800;
    display: none;
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
}

.completion-screen.show {
    display: block !important;
}

.completion-content {
    max-width: 380px;
    margin: 0 auto;
    padding: calc(var(--safe-top) + 40px) 24px calc(var(--safe-bottom) + 40px);
    text-align: center;
}

.completion-badge {
    width: 88px;
    height: 88px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--success) 0%, #059669 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 40px;
    margin: 0 auto 24px;
    box-shadow: 0 8px 32px rgba(16, 185, 129, 0.4);
}

.completion-title {
    font-size: 26px;
    font-weight: 800;
    margin: 0 0 8px;
}

.completion-subtitle {
    color: var(--text-secondary);
    font-size: 14px;
    margin: 0 0 28px;
}

.completion-stats {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius-lg);
    padding: 4px;
    margin-bottom: 24px;
    text-align: left;
}

.completion-stat {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 14px 16px;
    border-bottom: 1px solid var(--border);
}

.completion-stat:last-child {
    border-bottom: none;
}

.completion-stat-label {
    color: var(--text-secondary);
    font-size: 13px;
}

.completion-stat-value {
    font-size: 14px;
    font-weight: 700;
    font-family: 'JetBrains Mono', monospace;
}

.completion-content label {
    display: block;
    text-align: left;
    font-size: 12px;
    font-weight: 600;
    color: var(--text-muted);
    margin-bottom: 8px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.completion-content textarea {
    width: 100%;
    border-radius: var(--radius-md);
    border: 1px solid var(--border-light);
    background: var(--surface);
    color: var(--text);
    padding: 14px 16px;
    font-size: 14px;
    font-family: inherit;
    resize: vertical;
    min-height: 80px;
    margin-bottom: 20px;
    -webkit-appearance: none;
    appearance: none;
}

.completion-content textarea:focus {
    outline: none;
    border-color: var(--primary);
}

.completion-actions {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.toast {
    position: fixed;
    left: 50%;
    bottom: calc(90px + var(--safe-bottom));
    transform: translate(-50%, 20px);
    background: var(--surface-elevated);
    color: var(--text);
    padding: 14px 20px;
    border-radius: var(--radius-md);
    border: 1px solid var(--border-light);
    font-weight: 600;
    font-size: 14px;
    opacity: 0;
    transition: transform 0.3s ease, opacity 0.3s ease;
    z-index: 1200;
    pointer-events: none;
    max-width: calc(100% - 40px);
    text-align: center;
}

.toast.show {
    opacity: 1;
    transform: translate(-50%, 0);
}

.toast.success {
    background: var(--success);
    color: white;
    border-color: var(--success);
}

.toast.error {
    background: var(--danger);
    color: white;
    border-color: var(--danger);
}

.icon-btn-content {
    display: flex;
    align-items: center;
    justify-content: center;
}

.icon-btn-content svg {
    width: 20px;
    height: 20px;
    fill: currentColor;
}
</style>
</head>
<body>

<!-- HOME -->
<div id="tab-home" class="view active">
    <header class="page-header">
        <div class="page-header-row">
            <div>
                <h1 class="page-title">Cardio Sync</h1>
                <p class="page-subtitle">Choose Your Protocol</p>
            </div>
            <button type="button" class="btn-icon" onclick="ui.tab('stats')" aria-label="View stats">
                <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor"><path d="M3 13h2v8H3v-8zm4-6h2v14H7V7zm4-4h2v18h-2V3zm4 8h2v10h-2V11zm4-3h2v13h-2V8z"/></svg>
            </button>
        </div>
    </header>

    <div class="card card-glow">
        <div class="card-header">
            <div>
                <h2 class="card-title">Zone 2: Steady State</h2>
            </div>
            <div class="card-icon">ðŸ’§</div>
        </div>
        <p class="card-desc">30â€“45 min aerobic circuit. Nasal breathing only for optimal mitochondrial stimulus.</p>
        <div class="tags">
            <span class="tag primary">25/35lb DB</span>
            <span class="tag primary">35/50lb KB</span>
        </div>
        <button type="button" class="btn-primary" onclick="app.init('zone2')">Start Workout</button>
    </div>

    <div class="card">
        <div class="card-header">
            <div>
                <h2 class="card-title">Norwegian 4Ã—4</h2>
            </div>
            <div class="card-icon danger">âš¡</div>
        </div>
        <p class="card-desc">4 high-intensity work blocks. Push 85â€“95% HR with controlled active recovery periods.</p>
        <div class="tags">
            <span class="tag danger">Max Effort</span>
        </div>
        <button type="button" class="btn-primary" onclick="app.init('4x4')">Start Workout</button>
    </div>

    <div class="card">
        <div class="card-header">
            <div>
                <h2 class="card-title">Install App</h2>
            </div>
            <div class="card-icon accent">ðŸ“±</div>
        </div>
        <p class="card-desc">Add Cardio Sync to your home screen for the full-screen experience.</p>
        <div class="install-status" id="install-status">Checking device...</div>
        <ul id="install-steps" class="install-steps">
            <li class="install-step">
                <span class="step-number">1</span>
                <span class="step-text">Tap the <strong>Share</strong> button in Safari</span>
            </li>
            <li class="install-step">
                <span class="step-number">2</span>
                <span class="step-text">Select <strong>Add to Home Screen</strong></span>
            </li>
            <li class="install-step">
                <span class="step-number">3</span>
                <span class="step-text">Tap <strong>Add</strong> to confirm</span>
            </li>
        </ul>
        <button id="install-toggle" class="btn-secondary" type="button" onclick="toggleInstall()">Show Instructions</button>
    </div>

    <div class="section-header">
        <h3 class="section-title">Recent Activity</h3>
        <button type="button" class="section-link" onclick="ui.tab('stats')">View All â†’</button>
    </div>
    <div id="mini-stats"></div>
</div>

<!-- STATS -->
<div id="tab-stats" class="view">
    <header class="page-header">
        <div class="page-header-row">
            <div>
                <h1 class="page-title">Progress</h1>
                <p class="page-subtitle">Workout Analytics</p>
            </div>
            <button type="button" class="btn-icon" onclick="ui.modal('manual')" aria-label="Add manual log">
                <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
            </button>
        </div>
    </header>

    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-value" id="stat-total">0</div>
            <div class="stat-label">Total</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="stat-week">0</div>
            <div class="stat-label">This Week</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="stat-streak">0</div>
            <div class="stat-label">Streak</div>
        </div>
    </div>

    <div class="section-header">
        <h3 class="section-title">Workout History</h3>
    </div>
    <div id="full-stats"></div>
</div>

<!-- TIMER -->
<div id="view-timer" class="view">
    <div class="timer-layout">
        <div class="timer-header">
            <div class="timer-info">
                <div id="t-round" class="timer-round">ROUND 1/4</div>
                <div id="t-next" class="timer-next">NEXT: REST</div>
            </div>
            <div class="timer-header-right">
                <div id="workout-elapsed" class="workout-elapsed">00:00</div>
                <button type="button" class="btn-icon danger" onclick="app.showQuitModal()" aria-label="Quit">
                    <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
                </button>
            </div>
        </div>

        <div class="circle-wrap">
            <svg class="circle-svg" viewBox="0 0 300 300">
                <defs>
                    <linearGradient id="timer-gradient" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" stop-color="#6366f1"/>
                        <stop offset="100%" stop-color="#22d3ee"/>
                    </linearGradient>
                </defs>
                <circle class="circle-bg" cx="150" cy="150" r="134"></circle>
                <circle id="t-ring" class="circle-fg" cx="150" cy="150" r="134"></circle>
            </svg>
            <div class="timer-center">
                <div id="t-val" class="timer-value">00:00</div>
                <div id="t-label" class="timer-phase">WORK</div>
            </div>
        </div>

        <div class="exercise-info">
            <div id="t-name" class="exercise-title">Exercise</div>
            <div class="exercise-details">
                <span id="t-weight" class="editable" onclick="app.editWeight()">--</span>
                <span>â€¢</span>
                <span id="t-equip">--</span>
            </div>
            <div id="t-note" class="exercise-note">Instructions will appear here.</div>
        </div>

        <div class="timer-controls">
            <button type="button" class="control-btn" onclick="app.skip()" aria-label="Skip">
                <svg viewBox="0 0 24 24"><path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z"/></svg>
            </button>
            <button type="button" class="control-btn primary" onclick="app.addTime()" aria-label="Add 30s">+30</button>
        </div>
    </div>
</div>

<!-- COMPLETION -->
<div id="completion-screen" class="completion-screen">
    <div class="completion-content">
        <div class="completion-badge">âœ“</div>
        <h2 class="completion-title">Workout Complete!</h2>
        <p class="completion-subtitle">Great work. Every rep counts.</p>

        <div class="completion-stats">
            <div class="completion-stat">
                <span class="completion-stat-label">Workout Type</span>
                <span class="completion-stat-value" id="c-type">--</span>
            </div>
            <div class="completion-stat">
                <span class="completion-stat-label">Total Duration</span>
                <span class="completion-stat-value" id="c-duration">--</span>
            </div>
            <div class="completion-stat">
                <span class="completion-stat-label">Exercises</span>
                <span class="completion-stat-value" id="c-exercises">--</span>
            </div>
            <div class="completion-stat">
                <span class="completion-stat-label">Date</span>
                <span class="completion-stat-value" id="c-date">--</span>
            </div>
        </div>

        <label for="completion-notes">Notes (optional)</label>
        <textarea id="completion-notes" placeholder="How did it feel?"></textarea>

        <div class="completion-actions">
            <button type="button" class="btn-primary" onclick="app.saveCompletedWorkout(false)">Save Workout</button>
            <button type="button" class="btn-secondary" onclick="app.saveCompletedWorkout(true)">Save & View Progress</button>
        </div>
    </div>
</div>

<!-- MODAL -->
<div id="modal" class="modal"></div>

<!-- TOAST -->
<div id="toast" class="toast" role="status" aria-live="polite"></div>

<!-- NAV -->
<nav>
    <button id="nav-train" class="nav-btn active" onclick="ui.tab('home')" type="button">
        <svg viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>
        <span class="nav-label">Train</span>
    </button>
    <button id="nav-stats" class="nav-btn" onclick="ui.tab('stats')" type="button">
        <svg viewBox="0 0 24 24"><path d="M3 13h2v8H3v-8zm4-6h2v14H7V7zm4-4h2v18h-2V3zm4 8h2v10h-2V11zm4-3h2v13h-2V8z"/></svg>
        <span class="nav-label">Progress</span>
    </button>
</nav>

<script>
// Generate and inject apple-touch-icon dynamically
(function() {
    var canvas = document.createElement('canvas');
    canvas.width = 180;
    canvas.height = 180;
    var ctx = canvas.getContext('2d');
    
    // Background gradient
    var bgGrad = ctx.createLinearGradient(0, 0, 180, 180);
    bgGrad.addColorStop(0, '#1a1a2e');
    bgGrad.addColorStop(1, '#0a0a0f');
    
    // Draw rounded rectangle background
    ctx.beginPath();
    ctx.moveTo(40, 0);
    ctx.lineTo(140, 0);
    ctx.quadraticCurveTo(180, 0, 180, 40);
    ctx.lineTo(180, 140);
    ctx.quadraticCurveTo(180, 180, 140, 180);
    ctx.lineTo(40, 180);
    ctx.quadraticCurveTo(0, 180, 0, 140);
    ctx.lineTo(0, 40);
    ctx.quadraticCurveTo(0, 0, 40, 0);
    ctx.closePath();
    ctx.fillStyle = bgGrad;
    ctx.fill();
    
    // Pulse line gradient
    var lineGrad = ctx.createLinearGradient(20, 0, 160, 0);
    lineGrad.addColorStop(0, '#6366f1');
    lineGrad.addColorStop(1, '#22d3ee');
    
    // Draw heartbeat/pulse line
    ctx.beginPath();
    ctx.moveTo(20, 95);
    ctx.lineTo(45, 95);
    ctx.lineTo(55, 70);
    ctx.lineTo(70, 120);
    ctx.lineTo(90, 45);
    ctx.lineTo(110, 135);
    ctx.lineTo(125, 80);
    ctx.lineTo(135, 95);
    ctx.lineTo(160, 95);
    ctx.strokeStyle = lineGrad;
    ctx.lineWidth = 8;
    ctx.lineCap = 'round';
    ctx.lineJoin = 'round';
    ctx.stroke();
    
    // Convert to data URL and create link
    var dataUrl = canvas.toDataURL('image/png');
    var link = document.createElement('link');
    link.rel = 'apple-touch-icon';
    link.href = dataUrl;
    document.head.appendChild(link);
    
    // Also add sizes variants
    var link2 = document.createElement('link');
    link2.rel = 'apple-touch-icon';
    link2.sizes = '180x180';
    link2.href = dataUrl;
    document.head.appendChild(link2);
    
    var link3 = document.createElement('link');
    link3.rel = 'apple-touch-icon-precomposed';
    link3.href = dataUrl;
    document.head.appendChild(link3);
})();

var CIRCUMFERENCE = 2 * Math.PI * 134;

var WORKOUTS = {
    zone2: {
        title: "Zone 2: Steady State",
        type: "Zone 2",
        gen: function() {
            var block = [
                { n: "Weighted March", t: 180, w: "35/50lb KB", e: "Kettlebell", d: "Goblet hold, high knees, nasal breathing only." },
                { n: "Farmer's Carry", t: 180, w: "25/35lb DB", e: "Dumbbells", d: "Tall spine, calm breath, steady gait." },
                { n: "Step-Back Lunges", t: 120, w: "Bodyweight", e: "None", d: "Controlled alternating lunges, focus on balance." },
                { n: "Halo Extension", t: 120, w: "35lb KB", e: "Kettlebell", d: "Smooth halo, brace core, light grip." },
                { n: "Shadow Boxing", t: 120, w: "Light DB/BW", e: "Optional DB", d: "Snappy combos. Drop weight if HR spikes." }
            ];
            var queue = [];
            for (var i = 1; i <= 4; i++) {
                block.forEach(function(item) {
                    queue.push({ n: item.n, t: item.t, w: item.w, e: item.e, d: item.d, r: "ROUND " + i + "/4" });
                });
            }
            return queue;
        }
    },
    "4x4": {
        title: "Norwegian 4Ã—4",
        type: "Norwegian 4Ã—4",
        gen: function() {
            var queue = [
                { n: "Warmup Flow", t: 300, w: "Bodyweight", e: "None", d: "Dynamic prep. Ease up to 60% HR.", r: "WARMUP" }
            ];
            for (var i = 1; i <= 4; i++) {
                queue.push({ n: "KB Swings", t: 60, w: "35/50lb KB", e: "Kettlebell", d: "Explosive hip drive.", r: "ROUND " + i + "/4" });
                queue.push({ n: "DB Thrusters", t: 60, w: "25lb DB", e: "Dumbbells", d: "Deep squat into press.", r: "ROUND " + i + "/4" });
                queue.push({ n: "Mountain Climbers", t: 60, w: "Bodyweight", e: "None", d: "Sprint pace.", r: "ROUND " + i + "/4" });
                queue.push({ n: "Farmer Sprint Walk", t: 60, w: "Heavy DB/KB", e: "DB/KB", d: "Fast walk, max tension.", r: "ROUND " + i + "/4" });
                if (i < 4) {
                    queue.push({ n: "Active Recovery", t: 180, w: "â€”", e: "None", d: "Walk, breathe, keep moving.", r: "RECOVERY" });
                }
            }
            queue.push({ n: "Cool Down", t: 180, w: "â€”", e: "None", d: "Walk + stretch.", r: "COOLDOWN" });
            return queue;
        }
    }
};

var storage = {
    key: 'cardiosync_workouts',
    
    getAll: function() {
        try {
            var data = localStorage.getItem(this.key);
            if (!data) return [];
            var parsed = JSON.parse(data);
            if (!Array.isArray(parsed)) return [];
            return parsed.filter(function(w) {
                return w && typeof w === 'object' && w.id && w.timestamp;
            });
        } catch (e) {
            return [];
        }
    },
    
    save: function(workouts) {
        try {
            if (!Array.isArray(workouts)) return false;
            localStorage.setItem(this.key, JSON.stringify(workouts));
            return true;
        } catch (e) {
            return false;
        }
    },
    
    add: function(record) {
        try {
            if (!record || !record.id) return false;
            var workouts = this.getAll();
            workouts.unshift(record);
            return this.save(workouts);
        } catch (e) {
            return false;
        }
    },
    
    delete: function(id) {
        try {
            if (!id) return false;
            var workouts = this.getAll().filter(function(w) { return w.id !== id; });
            return this.save(workouts);
        } catch (e) {
            return false;
        }
    }
};

var app = {
    state: {
        active: false,
        queue: [],
        index: 0,
        timeLeft: 0,
        workoutType: '',
        workoutStart: null,
        exerciseSummary: [],
        actualDuration: 0,
        saving: false
    },
    timer: null,
    workoutTimer: null,
    audioCtx: null,
    cachedWorkouts: [],

    resetState: function() {
        this.state = {
            active: false,
            queue: [],
            index: 0,
            timeLeft: 0,
            workoutType: '',
            workoutStart: null,
            exerciseSummary: [],
            actualDuration: 0,
            saving: false
        };
    },

    init: function(type) {
        var preset = WORKOUTS[type];
        if (!preset) return;

        this.stopTimers();
        this.hideAllViews();

        this.state = {
            active: true,
            queue: preset.gen(),
            index: 0,
            timeLeft: 0,
            workoutType: preset.type,
            workoutStart: Date.now(),
            exerciseSummary: [],
            actualDuration: 0,
            saving: false
        };

        document.getElementById('view-timer').classList.add('active');
        this.loadExercise();
        this.startTimers();

        if (!this.audioCtx) {
            try {
                this.audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            } catch (e) {}
        }
    },

    hideAllViews: function() {
        document.querySelectorAll('.view').forEach(function(v) { v.classList.remove('active'); });
        document.getElementById('completion-screen').classList.remove('show');
    },

    startTimers: function() {
        var self = this;
        this.timer = setInterval(function() { self.tick(); }, 1000);
        this.workoutTimer = setInterval(function() { self.updateElapsed(); }, 1000);
    },

    stopTimers: function() {
        if (this.timer) { clearInterval(this.timer); this.timer = null; }
        if (this.workoutTimer) { clearInterval(this.workoutTimer); this.workoutTimer = null; }
    },

    loadExercise: function() {
        var s = this.state;
        if (!s.queue || s.index >= s.queue.length) {
            this.showCompletion();
            return;
        }
        
        var ex = s.queue[s.index];
        if (!ex) {
            this.showCompletion();
            return;
        }
        
        s.timeLeft = ex.t || 60;

        document.getElementById('t-name').textContent = ex.n || 'Exercise';
        document.getElementById('t-weight').textContent = ex.w || '--';
        document.getElementById('t-equip').textContent = ex.e || '--';
        document.getElementById('t-note').textContent = ex.d || '';
        document.getElementById('t-val').textContent = this.formatClock(s.timeLeft);
        document.getElementById('t-round').textContent = ex.r || 'WORK';
        
        var nextEx = s.queue[s.index + 1];
        document.getElementById('t-next').textContent = nextEx ? 'NEXT: ' + (nextEx.n || '').toUpperCase() : 'FINISHING';

        var label = (ex.n || '').toLowerCase().indexOf('warmup') >= 0 ? 'WARMUP' :
                      ((ex.n || '').toLowerCase().indexOf('recover') >= 0 || (ex.n || '').toLowerCase().indexOf('cool') >= 0) ? 'RECOVER' : 'WORK';
        document.getElementById('t-label').textContent = label;

        this.updateRing(1);
    },

    tick: function() {
        var s = this.state;
        if (!s.active) return;

        var current = s.queue && s.queue[s.index];
        if (!current) {
            this.showCompletion();
            return;
        }

        s.timeLeft--;
        if (s.timeLeft < 0) s.timeLeft = 0;

        document.getElementById('t-val').textContent = this.formatClock(s.timeLeft);
        this.updateRing(s.timeLeft / Math.max(current.t || 1, 1));

        if (s.timeLeft <= 0) {
            this.playBeep();
            this.skip();
        }
    },

    skip: function() {
        if (!this.state.active) return;
        this.state.index++;
        this.loadExercise();
    },

    addTime: function() {
        if (!this.state.active) return;
        var current = this.state.queue && this.state.queue[this.state.index];
        if (!current) return;

        current.t = (current.t || 0) + 30;
        this.state.timeLeft += 30;
        document.getElementById('t-val').textContent = this.formatClock(this.state.timeLeft);
        this.updateRing(this.state.timeLeft / Math.max(current.t, 1));
        ui.toast('+30 seconds', 'info');
    },

    updateRing: function(progress) {
        var clamped = Math.min(Math.max(progress || 0, 0), 1);
        var offset = CIRCUMFERENCE * (1 - clamped);
        var ring = document.getElementById('t-ring');
        if (ring) ring.style.strokeDashoffset = offset;
    },

    updateElapsed: function() {
        if (!this.state.workoutStart) return;
        var elapsed = Math.floor((Date.now() - this.state.workoutStart) / 1000);
        var el = document.getElementById('workout-elapsed');
        if (el) el.textContent = this.formatClock(elapsed);
    },

    playBeep: function() {
        if (!this.audioCtx) return;
        try {
            var osc = this.audioCtx.createOscillator();
            var gain = this.audioCtx.createGain();
            osc.frequency.value = 800;
            gain.gain.value = 0.1;
            osc.connect(gain).connect(this.audioCtx.destination);
            osc.start();
            osc.stop(this.audioCtx.currentTime + 0.1);
        } catch (e) {}
    },

    showQuitModal: function() {
        var elapsed = this.state.workoutStart ? Math.floor((Date.now() - this.state.workoutStart) / 1000) : 0;
        ui.modal('quit', {
            completed: this.state.index || 0,
            total: (this.state.queue && this.state.queue.length) || 0,
            duration: this.formatDuration(elapsed)
        });
    },

    savePartial: function() {
        var elapsed = this.state.workoutStart ? Math.floor((Date.now() - this.state.workoutStart) / 1000) : 0;
        var queueSlice = this.state.queue ? this.state.queue.slice(0, this.state.index) : [];
        var summary = this.buildSummary(queueSlice);

        var success = storage.add({
            id: Date.now(),
            timestamp: Date.now(),
            date: this.formatDate(new Date()),
            type: (this.state.workoutType || 'Workout') + ' (Partial)',
            duration: elapsed,
            exercises: summary,
            notes: 'Stopped early'
        });

        if (success) {
            ui.toast('Partial workout saved', 'success');
        } else {
            ui.toast('Error saving workout', 'error');
        }
        
        ui.closeModal();
        this.stopTimers();
        this.resetState();
        this.hideAllViews();
        ui.renderStats();
        ui.tab('stats');
    },

    confirmQuit: function() {
        this.stopTimers();
        ui.closeModal();
        this.resetState();
        this.hideAllViews();
        ui.tab('home');
    },

    showCompletion: function() {
        this.stopTimers();
        this.state.active = false;
        this.hideAllViews();

        var elapsed = this.state.workoutStart ? Math.floor((Date.now() - this.state.workoutStart) / 1000) : 0;
        this.state.actualDuration = elapsed;
        this.state.exerciseSummary = this.buildSummary(this.state.queue || []);

        var cType = document.getElementById('c-type');
        var cDuration = document.getElementById('c-duration');
        var cExercises = document.getElementById('c-exercises');
        var cDate = document.getElementById('c-date');
        var completionNotes = document.getElementById('completion-notes');
        
        if (cType) cType.textContent = this.state.workoutType || '--';
        if (cDuration) cDuration.textContent = this.formatDuration(elapsed);
        
        var exerciseCount = 0;
        if (this.state.exerciseSummary && this.state.exerciseSummary.length) {
            exerciseCount = this.state.exerciseSummary.reduce(function(sum, ex) { 
                return sum + (ex && ex.rounds ? ex.rounds : 0); 
            }, 0);
        }
        if (cExercises) cExercises.textContent = exerciseCount;
        if (cDate) cDate.textContent = this.formatDate(new Date());
        if (completionNotes) completionNotes.value = '';

        document.getElementById('completion-screen').classList.add('show');
    },

    saveCompletedWorkout: function(goToStats) {
        if (this.state.saving) return;
        this.state.saving = true;

        var self = this;
        var notesEl = document.getElementById('completion-notes');
        var notes = notesEl ? notesEl.value.trim() : '';

        var record = {
            id: Date.now(),
            timestamp: Date.now(),
            date: this.formatDate(new Date()),
            type: this.state.workoutType || 'Workout',
            duration: this.state.actualDuration || 0,
            exercises: this.state.exerciseSummary || [],
            notes: notes
        };

        var success = storage.add(record);

        document.getElementById('completion-screen').classList.remove('show');

        if (success) {
            ui.toast('Workout saved!', 'success');
        } else {
            ui.toast('Error saving workout', 'error');
        }

        ui.renderStats();

        setTimeout(function() {
            ui.tab(goToStats ? 'stats' : 'home');
            self.resetState();
        }, 100);
    },

    buildSummary: function(list) {
        if (!list || !Array.isArray(list) || !list.length) return [];
        var map = {};
        list.forEach(function(item) {
            if (!item || !item.n) return;
            var key = item.n;
            if (!map[key]) {
                map[key] = { name: key, weight: item.w || '--', equipment: item.e || '--', rounds: 0, totalSeconds: 0 };
            }
            map[key].rounds++;
            map[key].totalSeconds += item.t || 0;
        });
        return Object.values(map);
    },

    editWeight: function() {
        var current = this.state.queue && this.state.queue[this.state.index];
        ui.modal('weight', { current: current ? (current.w || '') : '' });
    },

    saveWeight: function() {
        var input = document.getElementById('m-weight');
        var value = input ? input.value.trim() : '';
        if (!value) return;
        
        if (this.state.queue && this.state.queue[this.state.index]) {
            this.state.queue[this.state.index].w = value;
        }
        var weightEl = document.getElementById('t-weight');
        if (weightEl) weightEl.textContent = value;
        ui.closeModal();
        ui.toast('Weight updated', 'success');
    },

    logManual: function() {
        var typeEl = document.getElementById('m-type');
        var durationEl = document.getElementById('m-duration');
        var notesEl = document.getElementById('m-notes');
        
        var type = typeEl ? typeEl.value : 'Custom';
        var minutes = durationEl ? parseInt(durationEl.value, 10) : 0;
        var notes = notesEl ? notesEl.value.trim() : '';

        if (!minutes || minutes <= 0 || isNaN(minutes)) {
            ui.toast('Enter valid duration', 'error');
            return;
        }

        var success = storage.add({
            id: Date.now(),
            timestamp: Date.now(),
            date: this.formatDate(new Date()),
            type: type,
            duration: minutes * 60,
            exercises: [],
            notes: notes
        });

        if (success) {
            ui.toast('Workout logged', 'success');
        } else {
            ui.toast('Error logging workout', 'error');
        }
        ui.closeModal();
        ui.renderStats();
    },

    viewWorkout: function(idx) {
        var workout = this.cachedWorkouts && this.cachedWorkouts[idx];
        if (workout) ui.modal('view', { workout: workout });
    },

    deleteWorkout: function(id) {
        if (id) ui.modal('delete', { id: id });
    },

    confirmDelete: function(id) {
        if (!id) {
            ui.closeModal();
            return;
        }
        var success = storage.delete(id);
        if (success) {
            ui.toast('Deleted', 'info');
        } else {
            ui.toast('Error deleting', 'error');
        }
        ui.closeModal();
        ui.renderStats();
    },

    formatClock: function(seconds) {
        seconds = Math.max(0, parseInt(seconds, 10) || 0);
        var m = Math.floor(seconds / 60).toString().padStart(2, '0');
        var s = (seconds % 60).toString().padStart(2, '0');
        return m + ':' + s;
    },

    formatDuration: function(seconds) {
        seconds = Math.max(0, parseInt(seconds, 10) || 0);
        var h = Math.floor(seconds / 3600);
        var m = Math.floor((seconds % 3600) / 60);
        var s = seconds % 60;
        if (h > 0) return h + 'h ' + m + 'm';
        if (m > 0) return m + 'm ' + s + 's';
        return s + 's';
    },

    formatDate: function(date) {
        try {
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        } catch (e) {
            return 'Unknown date';
        }
    },

    getDuration: function(workout) {
        if (workout && workout.duration != null) {
            return this.formatClock(workout.duration);
        }
        return '00:00';
    },

    getExerciseCount: function(workout) {
        if (workout && Array.isArray(workout.exercises) && workout.exercises.length) {
            return workout.exercises.reduce(function(sum, ex) { 
                return sum + (ex && ex.rounds ? ex.rounds : 0); 
            }, 0);
        }
        return 0;
    },

    renderExercises: function(exercises) {
        if (!exercises || !Array.isArray(exercises) || !exercises.length) {
            return '<div class="empty-summary">No exercise data.</div>';
        }
        var self = this;
        var html = exercises.map(function(ex) {
            if (!ex || !ex.name) return '';
            return '<div class="exercise-chip">' +
                '<div class="exercise-name">' + (ex.name || 'Unknown') + '</div>' +
                '<div class="exercise-meta">' + (ex.rounds || 0) + ' rounds Â· ' + self.formatClock(ex.totalSeconds || 0) + '</div>' +
                '</div>';
        }).join('');
        return '<div class="exercise-grid">' + html + '</div>';
    }
};

var ui = {
    toastTimer: null,

    renderStats: function() {
        var data = storage.getAll();
        app.cachedWorkouts = data;

        var statTotal = document.getElementById('stat-total');
        var statWeek = document.getElementById('stat-week');
        var statStreak = document.getElementById('stat-streak');
        
        if (statTotal) statTotal.textContent = data.length;

        var weekAgo = Date.now() - 7 * 24 * 60 * 60 * 1000;
        var thisWeek = data.filter(function(w) { 
            return w && w.timestamp && w.timestamp >= weekAgo; 
        }).length;
        if (statWeek) statWeek.textContent = thisWeek;
        if (statStreak) statStreak.textContent = this.computeStreak(data);

        var html = '';
        if (data.length) {
            data.forEach(function(w, idx) {
                if (!w) return;
                var duration = app.getDuration(w);
                var exercises = app.getExerciseCount(w);
                var exerciseHtml = app.renderExercises(w.exercises);
                var notes = w.notes ? '<div class="history-notes">"' + w.notes + '"</div>' : '';

                html += '<details class="history-panel"><summary>' +
                    '<div class="history-summary">' +
                    '<div class="history-info">' +
                    '<div class="history-title">' + (w.type || 'Workout') + '</div>' +
                    '<div class="history-meta"><span>' + (w.date || 'Unknown') + '</span><span>Â·</span><span>' + exercises + ' exercises</span></div>' +
                    '</div>' +
                    '<div class="history-duration">' + duration + '</div>' +
                    '</div></summary>' +
                    '<div class="history-detail">' +
                    exerciseHtml + notes +
                    '<div class="history-actions">' +
                    '<button type="button" class="btn-icon" onclick="app.viewWorkout(' + idx + ')" aria-label="View"><svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg></button>' +
                    '<button type="button" class="btn-icon danger" onclick="app.deleteWorkout(' + w.id + ')" aria-label="Delete"><svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg></button>' +
                    '</div></div></details>';
            });
        } else {
            html = '<div class="empty-state"><div class="empty-icon">ðŸ’ª</div><div class="empty-text">No workouts yet.<br>Complete one to see progress.</div></div>';
        }
        var fullStats = document.getElementById('full-stats');
        if (fullStats) fullStats.innerHTML = html;

        var mini = data.slice(0, 3);
        var miniHtml = '';
        if (mini.length) {
            miniHtml = '<div class="mini-stats">';
            mini.forEach(function(w) {
                if (!w) return;
                miniHtml += '<div class="mini-stat-row">' +
                    '<span class="mini-stat-date">' + (w.date || 'Unknown') + '</span>' +
                    '<span class="mini-stat-type">' + (w.type || 'Workout') + '</span>' +
                    '<span class="mini-stat-duration">' + app.getDuration(w) + '</span>' +
                    '</div>';
            });
            miniHtml += '</div>';
        } else {
            miniHtml = '<div class="empty-state" style="padding:24px"><div class="empty-text">Complete a workout to see activity.</div></div>';
        }
        var miniStats = document.getElementById('mini-stats');
        if (miniStats) miniStats.innerHTML = miniHtml;
    },

    computeStreak: function(workouts) {
        if (!workouts || !Array.isArray(workouts) || !workouts.length) return 0;
        
        var daysSet = {};
        workouts.forEach(function(w) {
            if (w && w.timestamp) {
                try {
                    daysSet[new Date(w.timestamp).toDateString()] = true;
                } catch (e) {}
            }
        });
        
        var days = Object.keys(daysSet);
        if (!days.length) return 0;
        
        days.sort(function(a, b) { 
            try {
                return new Date(b) - new Date(a); 
            } catch (e) {
                return 0;
            }
        });
        
        var streak = 0;
        var currentDate = new Date();
        currentDate.setHours(0, 0, 0, 0);

        for (var i = 0; i < days.length; i++) {
            try {
                var dayDate = new Date(days[i]);
                dayDate.setHours(0, 0, 0, 0);
                var diff = Math.round((currentDate - dayDate) / (1000 * 60 * 60 * 24));
                
                if (diff <= 1) {
                    streak++;
                    currentDate = dayDate;
                } else {
                    break;
                }
            } catch (e) {
                break;
            }
        }
        return streak;
    },

    tab: function(name) {
        document.querySelectorAll('.view').forEach(function(v) {
            if (v.id !== 'view-timer' && v.id !== 'completion-screen') {
                v.classList.remove('active');
            }
        });

        var target = document.getElementById('tab-' + name);
        if (target) target.classList.add('active');

        document.querySelectorAll('.nav-btn').forEach(function(btn) { btn.classList.remove('active'); });
        
        if (name === 'home') {
            var navTrain = document.getElementById('nav-train');
            if (navTrain) navTrain.classList.add('active');
        } else if (name === 'stats') {
            var navStats = document.getElementById('nav-stats');
            if (navStats) navStats.classList.add('active');
            this.renderStats();
        }
    },

    modal: function(type, data) {
        data = data || {};
        var modal = document.getElementById('modal');
        if (!modal) return;
        
        var html = '';

        if (type === 'weight') {
            html = '<div class="modal-card">' +
                '<h3 class="modal-title">Edit Weight</h3>' +
                '<label for="m-weight">Weight / Load</label>' +
                '<input id="m-weight" placeholder="e.g. 35lb KB" value="' + (data.current || '') + '">' +
                '<div class="modal-actions">' +
                '<button type="button" class="modal-btn modal-btn-cancel" onclick="ui.closeModal()">Cancel</button>' +
                '<button type="button" class="modal-btn modal-btn-primary" onclick="app.saveWeight()">Save</button>' +
                '</div></div>';
        } else if (type === 'manual') {
            html = '<div class="modal-card">' +
                '<h3 class="modal-title">Log Workout</h3>' +
                '<label for="m-type">Type</label>' +
                '<select id="m-type"><option>Zone 2</option><option>Norwegian 4Ã—4</option><option>Custom</option></select>' +
                '<label for="m-duration">Duration (minutes)</label>' +
                '<input id="m-duration" type="number" min="1" placeholder="30">' +
                '<label for="m-notes">Notes</label>' +
                '<textarea id="m-notes" rows="3" placeholder="How did it feel?"></textarea>' +
                '<div class="modal-actions">' +
                '<button type="button" class="modal-btn modal-btn-cancel" onclick="ui.closeModal()">Cancel</button>' +
                '<button type="button" class="modal-btn modal-btn-primary" onclick="app.logManual()">Save</button>' +
                '</div></div>';
        } else if (type === 'quit') {
            html = '<div class="modal-card">' +
                '<h3 class="modal-title">End Workout?</h3>' +
                '<p style="color:var(--text-secondary);margin:0 0 8px">Completed ' + (data.completed || 0) + '/' + (data.total || 0) + ' exercises</p>' +
                '<p style="color:var(--text-muted);font-size:13px;margin:0 0 20px">Elapsed: ' + (data.duration || '0s') + '</p>' +
                '<div style="display:flex;flex-direction:column;gap:10px">' +
                '<button type="button" class="modal-btn modal-btn-primary" onclick="app.savePartial()">Save & Exit</button>' +
                '<button type="button" class="modal-btn modal-btn-cancel" onclick="ui.closeModal()">Continue</button>' +
                '<button type="button" class="modal-btn modal-btn-danger" onclick="app.confirmQuit()">Discard & Exit</button>' +
                '</div></div>';
        } else if (type === 'delete') {
            html = '<div class="modal-card">' +
                '<h3 class="modal-title">Delete Workout?</h3>' +
                '<p style="color:var(--text-secondary);margin:0 0 20px">This cannot be undone.</p>' +
                '<div class="modal-actions">' +
                '<button type="button" class="modal-btn modal-btn-cancel" onclick="ui.closeModal()">Cancel</button>' +
                '<button type="button" class="modal-btn modal-btn-danger" onclick="app.confirmDelete(' + (data.id || 0) + ')">Delete</button>' +
                '</div></div>';
        } else if (type === 'view') {
            var w = data.workout || {};
            html = '<div class="modal-card">' +
                '<h3 class="modal-title">' + (w.type || 'Workout') + '</h3>' +
                '<div style="background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-md);padding:4px;margin-bottom:20px">' +
                '<div style="display:flex;justify-content:space-between;padding:12px 16px;border-bottom:1px solid var(--border)"><span style="color:var(--text-secondary);font-size:13px">Date</span><strong style="font-size:13px">' + (w.date || 'Unknown') + '</strong></div>' +
                '<div style="display:flex;justify-content:space-between;padding:12px 16px;border-bottom:1px solid var(--border)"><span style="color:var(--text-secondary);font-size:13px">Duration</span><strong style="font-size:13px">' + app.getDuration(w) + '</strong></div>' +
                '<div style="display:flex;justify-content:space-between;padding:12px 16px"><span style="color:var(--text-secondary);font-size:13px">Exercises</span><strong style="font-size:13px">' + app.getExerciseCount(w) + '</strong></div>' +
                '</div>' +
                '<div style="margin-bottom:20px"><div style="font-size:11px;color:var(--text-muted);letter-spacing:1px;text-transform:uppercase;margin-bottom:12px">Breakdown</div>' +
                app.renderExercises(w.exercises) + '</div>' +
                (w.notes ? '<div class="history-notes" style="margin-bottom:20px">"' + w.notes + '"</div>' : '') +
                '<button type="button" class="modal-btn modal-btn-primary" style="width:100%" onclick="ui.closeModal()">Close</button>' +
                '</div>';
        }

        modal.innerHTML = html;
        modal.classList.add('open');
    },

    closeModal: function() {
        var modal = document.getElementById('modal');
        if (modal) modal.classList.remove('open');
    },

    toast: function(message, type) {
        type = type || 'info';
        var toast = document.getElementById('toast');
        if (!toast) return;
        
        toast.textContent = message || '';
        toast.className = 'toast show ' + type;
        
        var self = this;
        clearTimeout(this.toastTimer);
        this.toastTimer = setTimeout(function() {
            toast.classList.remove('show');
        }, 3000);
    }
};

function toggleInstall() {
    var steps = document.getElementById('install-steps');
    var btn = document.getElementById('install-toggle');
    if (steps) steps.classList.toggle('show');
    if (btn) btn.textContent = (steps && steps.classList.contains('show')) ? 'Hide Instructions' : 'Show Instructions';
}

function updateInstallStatus() {
    var status = document.getElementById('install-status');
    if (!status) return;
    
    var isIOS = /iphone|ipad|ipod/i.test(navigator.userAgent);
    var standalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;

    if (standalone) {
        status.textContent = 'App is installed';
        var btn = document.getElementById('install-toggle');
        if (btn) {
            btn.disabled = true;
            btn.style.opacity = '0.5';
        }
    } else if (isIOS) {
        status.textContent = 'iPhone detected';
    } else {
        status.textContent = 'Open in Safari on iPhone';
    }
}

document.addEventListener('DOMContentLoaded', function() {
    updateInstallStatus();
    ui.renderStats();
});
</script>
</body>
</html>
