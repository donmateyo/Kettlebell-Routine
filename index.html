<!doctype html>
<!--
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë  KETTLEBELL COMPLEX TRACKER ‚Äî Premium Offline PWA                            ‚ïë
‚ïë  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê ‚ïë
‚ïë                                                                              ‚ïë
‚ïë  HOW TO SELF-HOST:                                                           ‚ïë
‚ïë  1. Save this file as index.html                                             ‚ïë
‚ïë  2. Upload to any static host (Netlify, Vercel, GitHub Pages, S3, etc.)      ‚ïë
‚ïë  3. Serve over HTTPS (required for PWA/Service Worker)                       ‚ïë
‚ïë  4. Done! Users can install to home screen for offline use.                  ‚ïë
‚ïë                                                                              ‚ïë
‚ïë  PROGRAM: Single KB Complex                                                  ‚ïë
‚ïë  - Clean + Press L, Clean + Press R, 2-4 Offset Front Squats                 ‚ïë
‚ïë  - Alternate starting side each round                                        ‚ïë
‚ïë  - Target: 30 rounds = 90 squats, 60 cleans, 30 presses                      ‚ïë
‚ïë                                                                              ‚ïë
‚ïë  Author: Senior Front-End Engineer                                           ‚ïë
‚ïë  License: MIT                                                                ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
-->
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" 
        content="width=device-width,initial-scale=1,user-scalable=no">
  <meta http-equiv="Content-Security-Policy" 
        content="default-src 'self' data: blob:;
                 script-src 'self' 'unsafe-inline' blob:;
                 style-src 'self' 'unsafe-inline';
                 img-src 'self' data: blob:;
                 connect-src 'self';">
  <meta name="theme-color" content="#0f172a" id="themeColor">
  <meta name="description" 
        content="Premium kettlebell workout tracker - works offline">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>KB Complex Tracker</title>
  
  <link rel="icon" id="favicon" href="data:image/svg+xml,<svg 
    xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'>
    <text y='.9em' font-size='90'>üèãÔ∏è</text></svg>">
  
  <style>
:root {
  --bg-0: #0f172a;
  --bg-1: #1e293b;
  --bg-2: #334155;
  --bg-3: #475569;
  --text-0: #f8fafc;
  --text-1: #e2e8f0;
  --text-2: #94a3b8;
  --accent: #f97316;
  --accent-glow: rgba(249, 115, 22, 0.4);
  --success: #22c55e;
  --warning: #eab308;
  --danger: #ef4444;
  --radius: 12px;
  --shadow: 0 4px 24px rgba(0,0,0,0.3);
  --transition: 0.2s ease;
  color-scheme: dark;
}

[data-theme="light"] {
  --bg-0: #f1f5f9;
  --bg-1: #ffffff;
  --bg-2: #e2e8f0;
  --bg-3: #cbd5e1;
  --text-0: #0f172a;
  --text-1: #1e293b;
  --text-2: #64748b;
  --accent: #ea580c;
  --accent-glow: rgba(234, 88, 12, 0.3);
  --shadow: 0 4px 24px rgba(0,0,0,0.1);
  color-scheme: light;
}

*, *::before, *::after {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

html {
  font-size: 16px;
  -webkit-tap-highlight-color: transparent;
}

body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto,
               'Helvetica Neue', Arial, sans-serif;
  background: var(--bg-0);
  color: var(--text-0);
  min-height: 100vh;
  min-height: 100dvh;
  line-height: 1.5;
  transition: background var(--transition), color var(--transition);
  overflow-x: hidden;
}

button {
  font-family: inherit;
  font-size: inherit;
  border: none;
  cursor: pointer;
  background: var(--bg-2);
  color: var(--text-0);
  padding: 0.75rem 1.25rem;
  border-radius: var(--radius);
  transition: all var(--transition);
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 0.5rem;
}

button:hover, button:focus-visible {
  background: var(--bg-3);
  transform: translateY(-1px);
}

button:focus-visible {
  outline: 2px solid var(--accent);
  outline-offset: 2px;
}

button:active {
  transform: translateY(0);
}

button.primary {
  background: var(--accent);
  color: white;
  font-weight: 600;
  box-shadow: 0 4px 16px var(--accent-glow);
}

button.primary:hover {
  filter: brightness(1.1);
}

button.danger {
  background: var(--danger);
  color: white;
}

button.small {
  padding: 0.5rem 0.75rem;
  font-size: 0.875rem;
}

button.icon-btn {
  width: 48px;
  height: 48px;
  padding: 0;
  border-radius: 50%;
}

button:disabled, button.disabled {
  opacity: 0.5;
  cursor: not-allowed;
  pointer-events: none;
}

button.completed {
  background: var(--success);
  color: white;
}

input, select {
  font-family: inherit;
  font-size: 1rem;
  padding: 0.75rem 1rem;
  border: 2px solid var(--bg-3);
  border-radius: var(--radius);
  background: var(--bg-1);
  color: var(--text-0);
  transition: border-color var(--transition);
}

input:focus, select:focus {
  outline: none;
  border-color: var(--accent);
}

input[type="range"] {
  -webkit-appearance: none;
  background: var(--bg-2);
  height: 8px;
  border-radius: 4px;
  padding: 0;
  border: none;
}

input[type="range"]::-webkit-slider-thumb {
  -webkit-appearance: none;
  width: 24px;
  height: 24px;
  background: var(--accent);
  border-radius: 50%;
  cursor: pointer;
  box-shadow: 0 2px 8px var(--accent-glow);
}

label {
  font-weight: 500;
  color: var(--text-2);
  font-size: 0.875rem;
  text-transform: uppercase;
  letter-spacing: 0.05em;
}

.app {
  max-width: 600px;
  margin: 0 auto;
  padding: 1rem;
  padding-bottom: 100px;
}

header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 0.5rem 0 1rem;
}

.logo {
  font-size: 1.25rem;
  font-weight: 700;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.logo svg {
  width: 32px;
  height: 32px;
}

.header-actions {
  display: flex;
  gap: 0.5rem;
}

.card {
  background: var(--bg-1);
  border-radius: var(--radius);
  padding: 1.5rem;
  box-shadow: var(--shadow);
  margin-bottom: 1rem;
}

.card h2 {
  font-size: 1rem;
  color: var(--text-2);
  margin-bottom: 1rem;
  text-transform: uppercase;
  letter-spacing: 0.05em;
}

.screen {
  display: none;
  animation: fadeIn 0.3s ease;
}

.screen.active {
  display: block;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

.nav {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background: var(--bg-1);
  border-top: 1px solid var(--bg-2);
  display: flex;
  justify-content: space-around;
  padding: 0.5rem;
  padding-bottom: max(0.5rem, env(safe-area-inset-bottom));
  z-index: 100;
}

.nav button {
  flex: 1;
  max-width: 80px;
  background: transparent;
  flex-direction: column;
  gap: 0.25rem;
  padding: 0.5rem;
  font-size: 0.75rem;
  color: var(--text-2);
}

.nav button.active {
  color: var(--accent);
}

.nav button svg {
  width: 24px;
  height: 24px;
}

.form-group {
  margin-bottom: 1.25rem;
}

.form-group label {
  display: block;
  margin-bottom: 0.5rem;
}

.form-row {
  display: flex;
  gap: 0.75rem;
}

.form-row input, .form-row select {
  flex: 1;
}

.weight-input {
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.weight-input input {
  width: 100px;
  text-align: center;
  font-size: 1.25rem;
  font-weight: 600;
}

.unit-toggle {
  display: flex;
  background: var(--bg-2);
  border-radius: var(--radius);
  overflow: hidden;
}

.unit-toggle button {
  border-radius: 0;
  padding: 0.5rem 1rem;
  font-size: 0.875rem;
}

.unit-toggle button.active {
  background: var(--accent);
  color: white;
}

.mode-cards {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 0.75rem;
}

.mode-card {
  background: var(--bg-2);
  border: 2px solid transparent;
  border-radius: var(--radius);
  padding: 1rem;
  text-align: center;
  cursor: pointer;
  transition: all var(--transition);
}

.mode-card:hover {
  border-color: var(--accent);
}

.mode-card.selected {
  border-color: var(--accent);
  background: rgba(249, 115, 22, 0.1);
}

.mode-card .icon {
  font-size: 2rem;
  margin-bottom: 0.5rem;
}

.mode-card .name {
  font-weight: 600;
  font-size: 0.875rem;
}

.mode-card .desc {
  font-size: 0.7rem;
  color: var(--text-2);
  margin-top: 0.25rem;
  line-height: 1.3;
}

.duration-slider {
  margin-top: 1rem;
}

.duration-slider .value {
  text-align: center;
  font-size: 1.5rem;
  font-weight: 700;
  color: var(--accent);
  margin-bottom: 0.5rem;
}

.duration-slider input[type="range"] {
  width: 100%;
}

.rounds-goal {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  margin-top: 1rem;
}

.rounds-goal input {
  width: 80px;
  text-align: center;
  font-size: 1.25rem;
  font-weight: 600;
}

.emom-note {
  margin-top: 1rem;
  text-align: center;
  color: var(--text-2);
  font-size: 0.875rem;
  font-style: italic;
}

.timer-display {
  text-align: center;
  padding: 2rem 0;
}

.timer-value {
  font-size: 4rem;
  font-weight: 700;
  font-variant-numeric: tabular-nums;
  letter-spacing: -2px;
  line-height: 1;
  background: linear-gradient(135deg, var(--accent), #fb923c);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.timer-label {
  font-size: 0.875rem;
  color: var(--text-2);
  text-transform: uppercase;
  letter-spacing: 0.1em;
  margin-top: 0.5rem;
}

.round-counter {
  text-align: center;
  padding: 1rem 0;
}

.round-display {
  font-size: 4rem;
  font-weight: 800;
  line-height: 1;
  color: var(--accent);
}

.round-label {
  font-size: 0.875rem;
  color: var(--text-2);
  text-transform: uppercase;
  margin-top: 0.5rem;
}

.exercise-row {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  margin-bottom: 0.75rem;
  padding: 0.75rem;
  background: var(--bg-2);
  border-radius: var(--radius);
  transition: all var(--transition);
}

.exercise-row.disabled {
  opacity: 0.5;
}

.exercise-row.left {
  border-left: 4px solid #3b82f6;
}

.exercise-row.right {
  border-left: 4px solid #22c55e;
}

.exercise-row.squat {
  border-left: 4px solid var(--accent);
}

.exercise-row .dec-btn,
.exercise-row .inc-btn {
  width: 44px;
  height: 44px;
  padding: 0;
  font-size: 1.25rem;
  font-weight: 700;
  border-radius: 50%;
  flex-shrink: 0;
}

.exercise-row .exercise-info {
  flex: 1;
  text-align: center;
}

.exercise-row .exercise-label {
  font-weight: 600;
  font-size: 1rem;
  display: block;
}

.exercise-row .exercise-target {
  font-size: 0.75rem;
  color: var(--text-2);
}

.exercise-row .rep-count {
  min-width: 2rem;
  text-align: center;
  font-size: 1.5rem;
  font-weight: 700;
  color: var(--accent);
}

.exercise-row.complete .inc-btn {
  background: var(--success);
  color: white;
}

.progress-container {
  margin: 1.5rem 0;
}

.progress-bar {
  height: 12px;
  background: var(--bg-2);
  border-radius: 6px;
  overflow: hidden;
  position: relative;
}

.progress-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--accent), var(--success));
  border-radius: 6px;
  transition: width 0.3s ease;
  position: relative;
}

.progress-fill::after {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: linear-gradient(
    90deg,
    transparent 0%,
    rgba(255,255,255,0.2) 50%,
    transparent 100%
  );
  animation: shimmer 2s infinite;
}

@keyframes shimmer {
  0% { transform: translateX(-100%); }
  100% { transform: translateX(100%); }
}

.progress-labels {
  display: flex;
  justify-content: space-between;
  font-size: 0.75rem;
  color: var(--text-2);
  margin-top: 0.5rem;
}

.workout-info {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 1rem;
  text-align: center;
}

.info-item .value {
  font-size: 1.5rem;
  font-weight: 700;
}

.info-item .label {
  font-size: 0.75rem;
  color: var(--text-2);
  text-transform: uppercase;
}

.workout-controls {
  display: flex;
  gap: 0.75rem;
  flex-wrap: wrap;
  justify-content: center;
  margin-top: 1.5rem;
}

.rest-timer {
  text-align: center;
  padding: 2rem;
  background: var(--bg-2);
  border-radius: var(--radius);
  margin: 1rem 0;
}

.rest-timer .time {
  font-size: 3rem;
  font-weight: 700;
  color: var(--accent);
}

.rest-timer .breathing {
  margin-top: 1rem;
  font-size: 1.25rem;
  color: var(--text-2);
  animation: breathe 4s ease-in-out infinite;
}

@keyframes breathe {
  0%, 100% { opacity: 0.5; transform: scale(1); }
  50% { opacity: 1; transform: scale(1.05); }
}

.rest-slider {
  margin-top: 1rem;
}

.rest-slider input {
  width: 100%;
}

.workout-complete-banner {
  background: linear-gradient(135deg, var(--success), #16a34a);
  color: white;
  padding: 1rem;
  border-radius: var(--radius);
  text-align: center;
  margin-bottom: 1rem;
  font-weight: 600;
}

.calendar {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 4px;
  margin-bottom: 1rem;
}

.calendar-header {
  font-size: 0.75rem;
  color: var(--text-2);
  text-align: center;
  padding: 0.25rem;
}

.calendar-day {
  aspect-ratio: 1;
  border-radius: 4px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 0.75rem;
  cursor: pointer;
  transition: all var(--transition);
  position: relative;
}

.calendar-day:hover {
  transform: scale(1.1);
}

.calendar-day.empty {
  background: transparent;
  cursor: default;
}

.calendar-day.empty:hover {
  transform: none;
}

.calendar-day.today {
  border: 2px solid var(--accent);
}

.calendar-day.has-workout {
  background: var(--accent);
  color: white;
  font-weight: 600;
}

.calendar-day.has-workout.light {
  background: rgba(249, 115, 22, 0.3);
  color: var(--text-0);
}

.calendar-day.has-workout.medium {
  background: rgba(249, 115, 22, 0.6);
  color: white;
}

.calendar-day.has-workout.heavy {
  background: var(--accent);
  color: white;
}

.calendar-nav {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1rem;
}

.calendar-nav h3 {
  font-size: 1rem;
}

.workout-detail {
  background: var(--bg-2);
  border-radius: var(--radius);
  padding: 1rem;
  margin-top: 1rem;
  animation: slideUp 0.3s ease;
}

@keyframes slideUp {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}

.workout-detail h4 {
  margin-bottom: 0.75rem;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.workout-detail .stats {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 0.75rem;
}

.workout-detail .stat {
  background: var(--bg-1);
  padding: 0.75rem;
  border-radius: 8px;
}

.workout-detail .stat-value {
  font-size: 1.25rem;
  font-weight: 700;
}

.workout-detail .stat-label {
  font-size: 0.75rem;
  color: var(--text-2);
}

.stats-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 1rem;
}

.stat-card {
  background: var(--bg-2);
  border-radius: var(--radius);
  padding: 1.25rem;
  text-align: center;
}

.stat-card .icon {
  font-size: 2rem;
  margin-bottom: 0.5rem;
}

.stat-card .value {
  font-size: 2rem;
  font-weight: 700;
  color: var(--accent);
}

.stat-card .label {
  font-size: 0.75rem;
  color: var(--text-2);
  text-transform: uppercase;
  margin-top: 0.25rem;
}

.export-section {
  margin-top: 1.5rem;
}

.export-buttons {
  display: flex;
  gap: 0.75rem;
  flex-wrap: wrap;
}

.import-section {
  margin-top: 1rem;
}

.import-section input[type="file"] {
  display: none;
}

.modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.7);
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 1rem;
  z-index: 1000;
  opacity: 0;
  visibility: hidden;
  transition: all 0.3s ease;
}

.modal-overlay.active {
  opacity: 1;
  visibility: visible;
}

.modal {
  background: var(--bg-1);
  border-radius: var(--radius);
  padding: 1.5rem;
  max-width: 400px;
  width: 100%;
  max-height: 80vh;
  overflow-y: auto;
  transform: scale(0.9);
  transition: transform 0.3s ease;
}

.modal-overlay.active .modal {
  transform: scale(1);
}

.modal h3 {
  margin-bottom: 1rem;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.modal-actions {
  display: flex;
  gap: 0.75rem;
  margin-top: 1.5rem;
}

.modal-actions button {
  flex: 1;
}

.toast-container {
  position: fixed;
  top: 1rem;
  left: 50%;
  transform: translateX(-50%);
  z-index: 2000;
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
  pointer-events: none;
}

.toast {
  background: var(--bg-1);
  border: 1px solid var(--bg-3);
  border-radius: var(--radius);
  padding: 1rem 1.5rem;
  box-shadow: var(--shadow);
  display: flex;
  align-items: center;
  gap: 0.75rem;
  animation: toastIn 0.3s ease;
  pointer-events: auto;
}

.toast.success { border-color: var(--success); }
.toast.warning { border-color: var(--warning); }
.toast.error { border-color: var(--danger); }

.toast.hiding {
  animation: toastOut 0.3s ease forwards;
}

@keyframes toastIn {
  from { opacity: 0; transform: translateY(-20px); }
  to { opacity: 1; transform: translateY(0); }
}

@keyframes toastOut {
  from { opacity: 1; transform: translateY(0); }
  to { opacity: 0; transform: translateY(-20px); }
}

.confetti-container {
  position: fixed;
  inset: 0;
  pointer-events: none;
  z-index: 3000;
  overflow: hidden;
}

.confetti {
  position: absolute;
  width: 10px;
  height: 10px;
  animation: confettiFall 3s ease-out forwards;
}

@keyframes confettiFall {
  0% {
    transform: translateY(-100%) rotate(0deg);
    opacity: 1;
  }
  100% {
    transform: translateY(100vh) rotate(720deg);
    opacity: 0;
  }
}

.sr-only {
  position: absolute;
  width: 1px;
  height: 1px;
  padding: 0;
  margin: -1px;
  overflow: hidden;
  clip: rect(0, 0, 0, 0);
  white-space: nowrap;
  border: 0;
}

:focus-visible {
  outline: 2px solid var(--accent);
  outline-offset: 2px;
}

@media (prefers-reduced-motion: reduce) {
  *, *::before, *::after {
    animation-duration: 0.01ms !important;
    animation-iteration-count: 1 !important;
    transition-duration: 0.01ms !important;
  }
}

@media (min-width: 768px) {
  .app { padding: 2rem; }
  .timer-value { font-size: 6rem; }
  .round-display { font-size: 6rem; }
  .mode-cards { gap: 1rem; }
  .stats-grid { grid-template-columns: repeat(4, 1fr); }
}

@media (min-width: 1024px) {
  .app { max-width: 800px; }
}
  </style>
</head>
<body>
  <div class="app" id="app">
    <header>
      <div class="logo" aria-label="Kettlebell Complex Tracker">
        <svg viewBox="0 0 32 32" fill="none" aria-hidden="true">
          <circle cx="16" cy="20" r="10" fill="var(--accent)"/>
          <path d="M10 8 Q16 2 22 8" stroke="var(--accent)" 
                stroke-width="3" fill="none" stroke-linecap="round"/>
          <circle cx="16" cy="20" r="4" fill="var(--bg-1)"/>
        </svg>
        <span>KB Tracker</span>
      </div>
      <div class="header-actions">
        <button class="icon-btn" id="themeToggle" 
                aria-label="Toggle dark/light theme">
          <svg id="themeIcon" viewBox="0 0 24 24" width="24" height="24" 
               fill="currentColor">
            <path id="sunPath" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 
              6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 
              17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"/>
          </svg>
        </button>
        <button class="icon-btn" id="soundToggle" aria-label="Toggle sound">
          <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor">
            <path d="M11 5L6 9H2v6h4l5 4V5zM15.54 8.46a5 5 0 010 7.07M19.07 
              4.93a10 10 0 010 14.14"/>
          </svg>
        </button>
      </div>
    </header>

    <!-- Setup Screen -->
    <section id="setupScreen" class="screen active" aria-label="Workout Setup">
      <div class="card">
        <h2>Workout Mode</h2>
        <div class="mode-cards" role="radiogroup" aria-label="Select workout mode">
          <div class="mode-card selected" data-mode="emom" role="radio" 
               aria-checked="true" tabindex="0">
            <div class="icon">‚è±Ô∏è</div>
            <div class="name">EMOM</div>
            <div class="desc">Every minute on the minute. 1 complex per minute for 15-45 min.</div>
          </div>
          <div class="mode-card" data-mode="timedsets" role="radio" 
               aria-checked="false" tabindex="0">
            <div class="icon">üî•</div>
            <div class="name">Timed Sets</div>
            <div class="desc">As many quality rounds as possible in 10-30 min.</div>
          </div>
          <div class="mode-card" data-mode="heavy" role="radio" 
               aria-checked="false" tabindex="0">
            <div class="icon">üí™</div>
            <div class="name">Heavy Day</div>
            <div class="desc">3-5 RM press, max sets in 15 min.</div>
          </div>
        </div>
        
        <div class="duration-slider">
          <label id="durationLabel">Duration</label>
          <div class="value" id="durationValue">20 min</div>
          <input type="range" id="durationSlider" min="15" max="45" value="20" 
                 step="5" aria-labelledby="durationLabel">
        </div>
      </div>

      <div class="card">
        <h2>Kettlebell Weight</h2>
        <div class="weight-input">
          <button class="icon-btn" id="weightDown" aria-label="Decrease weight">‚àí</button>
          <input type="number" id="weightInput" value="24" min="4" max="92" 
                 aria-label="Kettlebell weight">
          <button class="icon-btn" id="weightUp" aria-label="Increase weight">+</button>
          <div class="unit-toggle" role="radiogroup" aria-label="Weight unit">
            <button data-unit="kg" class="active" role="radio" 
                    aria-checked="true">kg</button>
            <button data-unit="lbs" role="radio" aria-checked="false">lbs</button>
          </div>
        </div>
        
        <div class="rounds-goal" id="roundsGoalContainer">
          <label for="roundsGoalInput">Rounds Goal</label>
          <button class="icon-btn" id="roundsGoalDown" aria-label="Decrease goal">‚àí</button>
          <input type="number" id="roundsGoalInput" value="10" min="1" max="99" 
                 aria-label="Rounds goal">
          <button class="icon-btn" id="roundsGoalUp" aria-label="Increase goal">+</button>
        </div>
        <div class="emom-note" id="emomNote">Rounds auto-advance each minute.</div>
      </div>

      <div class="card">
        <h2>Squat Reps per Round</h2>
        <div class="form-row">
          <button class="small" data-squats="2">2 Squats</button>
          <button class="small active" data-squats="3">3 Squats</button>
          <button class="small" data-squats="4">4 Squats</button>
        </div>
      </div>

      <div class="card">
        <h2>Rest Timer (seconds)</h2>
        <div class="rest-slider">
          <div class="value" id="restValue">45s</div>
          <input type="range" id="restSlider" min="30" max="60" value="45" 
                 aria-label="Rest duration in seconds">
        </div>
      </div>

      <button class="primary" id="startWorkout" 
              style="width:100%; margin-top:1rem; padding:1rem; font-size:1.25rem">
        Start Workout
      </button>
    </section>

    <!-- Workout Screen -->
    <section id="workoutScreen" class="screen" aria-label="Active Workout">
      <div id="workoutCompleteBanner" class="workout-complete-banner" 
           style="display:none">
        Workout Complete!
      </div>
      
      <div class="card">
        <div class="timer-display">
          <div class="timer-value" id="timerDisplay" aria-live="polite">20:00</div>
          <div class="timer-label" id="timerLabel">EMOM Timer</div>
        </div>
      </div>

      <div class="card">
        <div class="round-counter">
          <div class="round-display" id="roundDisplay">0</div>
          <div class="round-label">Rounds Completed</div>
        </div>

        <div id="exerciseRows">
          <div class="exercise-row left" id="exercise1Row">
            <button class="dec-btn" id="exercise1Dec" aria-label="Decrease Clean + Press Left">‚àí</button>
            <div class="exercise-info">
              <span class="exercise-label">Clean + Press Left</span>
              <span class="exercise-target">(1 rep)</span>
            </div>
            <span class="rep-count" id="exercise1Count">0</span>
            <button class="inc-btn" id="exercise1Inc" aria-label="Increase Clean + Press Left">+</button>
          </div>
          <div class="exercise-row right disabled" id="exercise2Row">
            <button class="dec-btn" id="exercise2Dec" aria-label="Decrease Clean + Press Right" disabled>‚àí</button>
            <div class="exercise-info">
              <span class="exercise-label">Clean + Press Right</span>
              <span class="exercise-target">(1 rep)</span>
            </div>
            <span class="rep-count" id="exercise2Count">0</span>
            <button class="inc-btn" id="exercise2Inc" aria-label="Increase Clean + Press Right" disabled>+</button>
          </div>
          <div class="exercise-row squat disabled" id="exercise3Row">
            <button class="dec-btn" id="exercise3Dec" aria-label="Decrease Squat" disabled>‚àí</button>
            <div class="exercise-info">
              <span class="exercise-label">Squat</span>
              <span class="exercise-target" id="squatTargetLabel">(3 reps)</span>
            </div>
            <span class="rep-count" id="exercise3Count">0</span>
            <button class="inc-btn" id="exercise3Inc" aria-label="Increase Squat" disabled>+</button>
          </div>
        </div>

        <div class="progress-container">
          <div class="progress-bar">
            <div class="progress-fill" id="progressFill" style="width: 0%"></div>
          </div>
          <div class="progress-labels">
            <span>0</span>
            <span id="targetLabel">Target: 10 rounds</span>
          </div>
        </div>
      </div>

      <div class="card" id="restCard" style="display: none">
        <div class="rest-timer">
          <div class="time" id="restDisplay">45</div>
          <div class="breathing" id="breathingGuide">Breathe in...</div>
          <div class="rest-slider">
            <input type="range" id="restAdjust" min="30" max="60" value="45" 
                   aria-label="Adjust rest time">
          </div>
          <button class="small" id="skipRest" style="margin-top:1rem">Skip Rest</button>
        </div>
      </div>

      <div class="card">
        <div class="workout-info" id="workoutInfo">
          <div class="info-item">
            <div class="value" id="cleanCount">0</div>
            <div class="label">Cleans</div>
          </div>
          <div class="info-item">
            <div class="value" id="pressCount">0</div>
            <div class="label">Presses</div>
          </div>
          <div class="info-item">
            <div class="value" id="squatCount">0</div>
            <div class="label">Squats</div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="workout-controls" id="workoutControls">
          <button class="small" id="editWeight">Edit Weight</button>
          <button class="small" id="restBtn">Rest</button>
          <button class="small danger" id="endWorkout">End Workout</button>
        </div>
        <div class="workout-controls" id="postWorkoutControls" style="display:none">
          <button class="primary" id="newWorkout" style="width:100%">New Workout</button>
        </div>
      </div>
    </section>

    <!-- History Screen -->
    <section id="historyScreen" class="screen" aria-label="Workout History">
      <div class="card">
        <div class="calendar-nav">
          <button class="small" id="prevMonth" aria-label="Previous month">Prev</button>
          <h3 id="calendarTitle">January 2026</h3>
          <button class="small" id="nextMonth" aria-label="Next month">Next</button>
        </div>
        <div class="calendar" id="calendar" role="grid" aria-label="Workout calendar">
          <div class="calendar-header">Su</div>
          <div class="calendar-header">Mo</div>
          <div class="calendar-header">Tu</div>
          <div class="calendar-header">We</div>
          <div class="calendar-header">Th</div>
          <div class="calendar-header">Fr</div>
          <div class="calendar-header">Sa</div>
        </div>
        <div id="workoutDetail"></div>
      </div>

      <div class="card">
        <h2>Add Past Workout</h2>
        <div class="form-group">
          <label for="retroDate">Date</label>
          <input type="date" id="retroDate">
        </div>
        <div class="form-row">
          <div class="form-group" style="flex:1">
            <label for="retroRounds">Rounds</label>
            <input type="number" id="retroRounds" value="15" min="1" max="100">
          </div>
          <div class="form-group" style="flex:1">
            <label for="retroWeight">Weight</label>
            <input type="number" id="retroWeight" value="24" min="4" max="92">
          </div>
        </div>
        <div class="form-group">
          <label for="retroMode">Mode</label>
          <select id="retroMode">
            <option value="emom">EMOM</option>
            <option value="timedsets">Timed Sets</option>
            <option value="heavy">Heavy Day</option>
          </select>
        </div>
        <button class="primary" id="saveRetro" style="width:100%">Save Workout</button>
      </div>
    </section>

    <!-- Stats Screen -->
    <section id="statsScreen" class="screen" aria-label="Statistics">
      <div class="card">
        <h2>All-Time Stats</h2>
        <div class="stats-grid">
          <div class="stat-card">
            <div class="icon">üìÖ</div>
            <div class="value" id="statSessions">0</div>
            <div class="label">Sessions</div>
          </div>
          <div class="stat-card">
            <div class="icon">üîÑ</div>
            <div class="value" id="statRounds">0</div>
            <div class="label">Rounds</div>
          </div>
          <div class="stat-card">
            <div class="icon">‚öñÔ∏è</div>
            <div class="value" id="statAvgWeight">0</div>
            <div class="label">Avg Weight</div>
          </div>
          <div class="stat-card">
            <div class="icon">üèãÔ∏è</div>
            <div class="value" id="statTonnage">0</div>
            <div class="label">Est. Tonnage</div>
          </div>
        </div>
      </div>

      <div class="card export-section">
        <h2>Export Data</h2>
        <div class="export-buttons">
          <button id="exportJSON">JSON</button>
          <button id="exportCSV">CSV</button>
          <button id="copyClipboard">Copy</button>
        </div>
      </div>

      <div class="card import-section">
        <h2>Import Data</h2>
        <input type="file" id="importFile" accept=".json">
        <button id="importBtn" style="width:100%">Import JSON</button>
      </div>

      <div class="card">
        <h2>Danger Zone</h2>
        <button class="danger" id="clearData" style="width:100%">Clear All Data</button>
      </div>
    </section>
  </div>

  <nav class="nav" role="navigation" aria-label="Main navigation">
    <button class="active" data-screen="setup" aria-current="page">
      <svg viewBox="0 0 24 24" fill="currentColor">
        <path d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10
          a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 
          1 0 001 1m-6 0h6"/>
      </svg>
      Home
    </button>
    <button data-screen="workout">
      <svg viewBox="0 0 24 24" fill="currentColor">
        <path d="M13 10V3L4 14h7v7l9-11h-7z"/>
      </svg>
      Workout
    </button>
    <button data-screen="history">
      <svg viewBox="0 0 24 24" fill="currentColor">
        <path d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5
          a2 2 0 00-2 2v12a2 2 0 002 2z"/>
      </svg>
      History
    </button>
    <button data-screen="stats">
      <svg viewBox="0 0 24 24" fill="currentColor">
        <path d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 
          2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 
          2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2
          a2 2 0 01-2-2z"/>
      </svg>
      Stats
    </button>
  </nav>

  <div class="modal-overlay" id="modalOverlay" role="dialog" aria-modal="true">
    <div class="modal" id="modal">
      <h3 id="modalTitle">Modal Title</h3>
      <div id="modalContent"></div>
      <div class="modal-actions" id="modalActions"></div>
    </div>
  </div>

  <div class="toast-container" id="toastContainer" aria-live="polite"></div>
  <div class="confetti-container" id="confettiContainer" aria-hidden="true"></div>

<script>
(function() {
  'use strict';

  const DB_NAME = 'kb-tracker-db';
  const DB_VERSION = 1;
  const STORE_NAME = 'workouts';
  const LS_KEY = 'kb-tracker-data';
  const STATE_KEY = 'kb-tracker-state';
  const SETTINGS_KEY = 'kb-tracker-settings';

  const ACHIEVEMENTS = { halfViking: 15, fullViking: 30, legend: 50 };

  let db = null;
  let soundEnabled = true;
  let audioCtx = null;

  // Exercise targets: [ex1, ex2, ex3] where ex3 is squats (dynamic)
  const EX_TARGETS = [1, 1, 3]; // ex3 updated from settings

  let workoutState = {
    active: false,
    completed: false,
    mode: 'emom',
    duration: 20,
    weight: 24,
    unit: 'kg',
    squatsPerRound: 3,
    restDuration: 45,
    rounds: 0,
    targetRounds: 10,
    startTime: null,
    elapsedSeconds: 0,
    isResting: false,
    lastMinuteTick: 0,
    // Current round reps
    currentEx: [0, 0, 0],
    // Round progress: which exercises are complete
    roundComplete: [false, false, false],
    // Totals
    cleansLeft: 0,
    cleansRight: 0,
    pressesLeft: 0,
    pressesRight: 0,
    squats: 0
  };

  let timerInterval = null;
  let restInterval = null;
  let restCountdown = 45;
  let calendarDate = new Date();
  let personalRecord = 0;

  const $ = (id) => document.getElementById(id);
  const $$ = (sel) => document.querySelectorAll(sel);

  // Settings persistence
  function loadSettings() {
    const saved = localStorage.getItem(SETTINGS_KEY);
    if (saved) {
      const s = JSON.parse(saved);
      workoutState.squatsPerRound = s.squatsPerRound || 3;
      EX_TARGETS[2] = workoutState.squatsPerRound;
    }
  }

  function saveSettings() {
    localStorage.setItem(SETTINGS_KEY, JSON.stringify({
      squatsPerRound: workoutState.squatsPerRound
    }));
  }

  function updateRoundsGoalVisibility() {
    const isEmom = workoutState.mode === 'emom';
    $('roundsGoalContainer').style.display = isEmom ? 'none' : 'flex';
    $('emomNote').style.display = isEmom ? 'block' : 'none';
  }

  async function initDatabase() {
    try {
      db = await new Promise((resolve, reject) => {
        const request = indexedDB.open(DB_NAME, DB_VERSION);
        request.onerror = () => reject(request.error);
        request.onsuccess = () => resolve(request.result);
        request.onupgradeneeded = (event) => {
          const database = event.target.result;
          if (!database.objectStoreNames.contains(STORE_NAME)) {
            const store = database.createObjectStore(STORE_NAME, {
              keyPath: 'id', autoIncrement: true
            });
            store.createIndex('date', 'date', { unique: false });
          }
        };
      });
    } catch (error) { db = null; }
  }

  async function saveWorkout(workout) {
    const workoutData = {
      ...workout,
      id: workout.id || Date.now(),
      date: workout.date || new Date().toISOString().split('T')[0],
      timestamp: workout.timestamp || Date.now()
    };
    if (db) {
      return new Promise((resolve, reject) => {
        const tx = db.transaction(STORE_NAME, 'readwrite');
        const store = tx.objectStore(STORE_NAME);
        const request = store.put(workoutData);
        request.onsuccess = () => resolve(request.result);
        request.onerror = () => reject(request.error);
      });
    } else {
      const data = JSON.parse(localStorage.getItem(LS_KEY) || '[]');
      const idx = data.findIndex(w => w.id === workoutData.id);
      if (idx >= 0) data[idx] = workoutData;
      else data.push(workoutData);
      localStorage.setItem(LS_KEY, JSON.stringify(data));
      return workoutData.id;
    }
  }

  async function getAllWorkouts() {
    if (db) {
      return new Promise((resolve, reject) => {
        const tx = db.transaction(STORE_NAME, 'readonly');
        const store = tx.objectStore(STORE_NAME);
        const request = store.getAll();
        request.onsuccess = () => resolve(request.result);
        request.onerror = () => reject(request.error);
      });
    }
    return JSON.parse(localStorage.getItem(LS_KEY) || '[]');
  }

  async function deleteWorkout(id) {
    if (db) {
      return new Promise((resolve, reject) => {
        const tx = db.transaction(STORE_NAME, 'readwrite');
        const store = tx.objectStore(STORE_NAME);
        store.delete(id);
        resolve();
      });
    }
    const data = JSON.parse(localStorage.getItem(LS_KEY) || '[]');
    localStorage.setItem(LS_KEY, JSON.stringify(data.filter(w => w.id !== id)));
  }

  async function clearAllWorkouts() {
    if (db) {
      return new Promise((resolve) => {
        const tx = db.transaction(STORE_NAME, 'readwrite');
        tx.objectStore(STORE_NAME).clear();
        resolve();
      });
    }
    localStorage.removeItem(LS_KEY);
  }

  function saveWorkoutState() {
    localStorage.setItem(STATE_KEY, JSON.stringify(workoutState));
  }

  function loadWorkoutState() {
    const saved = localStorage.getItem(STATE_KEY);
    return saved ? JSON.parse(saved) : null;
  }

  function clearWorkoutState() {
    localStorage.removeItem(STATE_KEY);
  }

  function initAudio() {
    if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    if (audioCtx.state === 'suspended') audioCtx.resume();
  }

  function playSound(freq, dur, type = 'sine', vol = 0.3) {
    if (!soundEnabled) return;
    initAudio();
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.connect(gain);
    gain.connect(audioCtx.destination);
    osc.type = type;
    osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
    gain.gain.setValueAtTime(vol, audioCtx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + dur);
    osc.start();
    osc.stop(audioCtx.currentTime + dur);
  }

  function playWhistle() {
    if (!soundEnabled) return;
    initAudio();
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.connect(gain);
    gain.connect(audioCtx.destination);
    osc.frequency.setValueAtTime(800, audioCtx.currentTime);
    osc.frequency.exponentialRampToValueAtTime(1200, audioCtx.currentTime + 0.1);
    osc.frequency.exponentialRampToValueAtTime(800, audioCtx.currentTime + 0.2);
    gain.gain.setValueAtTime(0.3, audioCtx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.5);
    osc.start();
    osc.stop(audioCtx.currentTime + 0.5);
  }

  function playClick() { playSound(1000, 0.05, 'square', 0.15); }
  function playBell() { playSound(440, 1.5, 'sine', 0.4); }

  function playRoundComplete() {
    if (!soundEnabled) return;
    initAudio();
    [523, 659, 784, 1047].forEach((freq, i) => {
      setTimeout(() => playSound(freq, 0.2, 'sine', 0.25), i * 80);
    });
  }

  function playRestChime() {
    if (!soundEnabled) return;
    [523, 659, 784].forEach((freq, i) => {
      setTimeout(() => playSound(freq, 0.3, 'sine', 0.2), i * 100);
    });
  }

  function haptic(d = 10) { if ('vibrate' in navigator) navigator.vibrate(d); }

  function initTheme() {
    const saved = localStorage.getItem('theme');
    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
    setTheme(saved || (prefersDark ? 'dark' : 'light'));
  }

  function setTheme(theme) {
    document.documentElement.setAttribute('data-theme', theme);
    $('themeColor').setAttribute('content', theme === 'dark' ? '#0f172a' : '#f1f5f9');
    const icon = $('themeIcon');
    icon.innerHTML = theme === 'dark' 
      ? '<circle cx="12" cy="12" r="5"/><path d="M12 1v2m0 18v2M4.22 4.22l1.42 1.42m12.72 12.72l1.42 1.42M1 12h2m18 0h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/>'
      : '<path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/>';
  }

  function toggleTheme() {
    const next = document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
    setTheme(next);
    localStorage.setItem('theme', next);
    haptic(5);
  }

  function formatTime(s) {
    return `${Math.floor(s/60).toString().padStart(2,'0')}:${(s%60).toString().padStart(2,'0')}`;
  }

  function startTimer() {
    const total = workoutState.duration * 60;
    let elapsed = workoutState.elapsedSeconds || 0;
    workoutState.lastMinuteTick = Math.floor(elapsed / 60);
    updateTimerDisplay(total - elapsed);
    timerInterval = setInterval(() => {
      elapsed++;
      workoutState.elapsedSeconds = elapsed;
      const remaining = total - elapsed;
      updateTimerDisplay(remaining);
      
      // EMOM: auto-advance rounds each minute
      if (workoutState.mode === 'emom') {
        const currentMinute = Math.floor(elapsed / 60);
        if (currentMinute > workoutState.lastMinuteTick && remaining > 0) {
          workoutState.lastMinuteTick = currentMinute;
          workoutState.rounds = currentMinute;
          playWhistle();
          haptic(50);
          showToast(`Minute ${currentMinute} - Round ${currentMinute}!`, 'success');
          // Reset exercise tracking for new round
          workoutState.currentEx = [0, 0, 0];
          workoutState.roundComplete = [false, false, false];
          updateWorkoutUI();
          updateExerciseStates();
        }
      }
      
      saveWorkoutState();
      if (remaining <= 0) endWorkout();
    }, 1000);
  }

  function updateTimerDisplay(s) {
    $('timerDisplay').textContent = formatTime(Math.max(0, s));
  }

  function stopTimer() {
    if (timerInterval) { clearInterval(timerInterval); timerInterval = null; }
  }

  function startRestTimer() {
    workoutState.isResting = true;
    restCountdown = workoutState.restDuration;
    $('restCard').style.display = 'block';
    $('restDisplay').textContent = restCountdown;
    $('restAdjust').value = restCountdown;
    playRestChime();
    let phase = 0;
    const texts = ['Breathe in...', 'Hold...', 'Breathe out...', 'Hold...'];
    restInterval = setInterval(() => {
      restCountdown--;
      $('restDisplay').textContent = restCountdown;
      if (restCountdown % 4 === 0) {
        phase = (phase + 1) % 4;
        $('breathingGuide').textContent = texts[phase];
      }
      if (restCountdown <= 3 && restCountdown > 0) playClick();
      if (restCountdown <= 0) {
        endRestTimer();
        playWhistle();
        haptic(100);
      }
    }, 1000);
  }

  function endRestTimer() {
    workoutState.isResting = false;
    if (restInterval) { clearInterval(restInterval); restInterval = null; }
    $('restCard').style.display = 'none';
  }

  // Lock-step exercise state machine
  function updateExerciseStates() {
    const rows = [$('exercise1Row'), $('exercise2Row'), $('exercise3Row')];
    const incBtns = [$('exercise1Inc'), $('exercise2Inc'), $('exercise3Inc')];
    const decBtns = [$('exercise1Dec'), $('exercise2Dec'), $('exercise3Dec')];
    const counts = [$('exercise1Count'), $('exercise2Count'), $('exercise3Count')];

    // Update squat target label
    $('squatTargetLabel').textContent = `(${workoutState.squatsPerRound} reps)`;
    EX_TARGETS[2] = workoutState.squatsPerRound;

    for (let i = 0; i < 3; i++) {
      const target = EX_TARGETS[i];
      const current = workoutState.currentEx[i];
      const isComplete = current >= target;

      counts[i].textContent = current;

      // Determine if this exercise is enabled
      let enabled = false;
      if (workoutState.active && !workoutState.completed) {
        if (i === 0) {
          // First exercise: enabled if not complete
          enabled = !isComplete;
        } else {
          // Subsequent exercises: enabled only if previous is complete AND this one isn't
          const prevComplete = workoutState.currentEx[i-1] >= EX_TARGETS[i-1];
          enabled = prevComplete && !isComplete;
        }
      }

      rows[i].classList.toggle('disabled', !enabled && !isComplete);
      rows[i].classList.toggle('complete', isComplete);
      incBtns[i].disabled = !enabled;
      incBtns[i].classList.toggle('completed', isComplete);
      decBtns[i].disabled = !workoutState.active || current <= 0;
    }
  }

  function checkRoundComplete() {
    // For non-EMOM modes, manually complete the round when all exercises are done
    if (workoutState.mode !== 'emom') {
      const allComplete = workoutState.currentEx.every((c, i) => c >= EX_TARGETS[i]);
      if (allComplete) {
        workoutState.rounds++;
        
        // Add to totals
        workoutState.cleansLeft += workoutState.currentEx[0];
        workoutState.pressesLeft += workoutState.currentEx[0];
        workoutState.cleansRight += workoutState.currentEx[1];
        workoutState.pressesRight += workoutState.currentEx[1];
        workoutState.squats += workoutState.currentEx[2];

        // Reset for next round
        workoutState.currentEx = [0, 0, 0];
        workoutState.roundComplete = [false, false, false];

        playRoundComplete();
        haptic(50);
        updateWorkoutUI();
        updateExerciseStates();
        saveWorkoutState();
        checkAchievements(workoutState.rounds);
        showToast(`Round ${workoutState.rounds} complete!`, 'success');
      }
    } else {
      // For EMOM, just track totals when exercises complete
      const allComplete = workoutState.currentEx.every((c, i) => c >= EX_TARGETS[i]);
      if (allComplete && !workoutState.roundComplete.every(x => x)) {
        // Mark round exercises as tracked
        workoutState.roundComplete = [true, true, true];
        
        // Add to totals
        workoutState.cleansLeft += workoutState.currentEx[0];
        workoutState.pressesLeft += workoutState.currentEx[0];
        workoutState.cleansRight += workoutState.currentEx[1];
        workoutState.pressesRight += workoutState.currentEx[1];
        workoutState.squats += workoutState.currentEx[2];
        
        playRoundComplete();
        haptic(50);
        updateWorkoutUI();
        saveWorkoutState();
        showToast('Complex complete!', 'success');
      }
    }
  }

  function incrementExercise(idx) {
    if (!workoutState.active || workoutState.completed) return;

    const target = EX_TARGETS[idx];
    const current = workoutState.currentEx[idx];

    // Check if allowed
    if (idx === 0) {
      if (current >= target) return; // Already complete
    } else {
      const prevComplete = workoutState.currentEx[idx-1] >= EX_TARGETS[idx-1];
      if (!prevComplete || current >= target) return;
    }

    workoutState.currentEx[idx]++;
    playClick();
    haptic(10);
    updateExerciseStates();
    saveWorkoutState();
    checkRoundComplete();
  }

  function decrementExercise(idx) {
    if (!workoutState.active || workoutState.completed) return;
    if (workoutState.currentEx[idx] <= 0) return;

    workoutState.currentEx[idx]--;
    haptic(5);

    // Re-lock subsequent exercises if this one drops below target
    for (let i = idx + 1; i < 3; i++) {
      // If previous exercise is now incomplete, we don't reset the counts
      // but we do re-evaluate locks in updateExerciseStates
    }

    updateExerciseStates();
    saveWorkoutState();
  }

  function startWorkout() {
    initAudio();
    
    workoutState.active = true;
    workoutState.completed = false;
    workoutState.rounds = 0;
    workoutState.startTime = Date.now();
    workoutState.elapsedSeconds = 0;
    workoutState.isResting = false;
    workoutState.lastMinuteTick = 0;
    workoutState.currentEx = [0, 0, 0];
    workoutState.roundComplete = [false, false, false];
    workoutState.cleansLeft = 0;
    workoutState.cleansRight = 0;
    workoutState.pressesLeft = 0;
    workoutState.pressesRight = 0;
    workoutState.squats = 0;
    
    // For EMOM, target rounds = duration in minutes
    if (workoutState.mode === 'emom') {
      workoutState.targetRounds = workoutState.duration;
    } else {
      workoutState.targetRounds = parseInt($('roundsGoalInput').value) || 10;
    }

    $('workoutCompleteBanner').style.display = 'none';
    $('workoutControls').style.display = 'flex';
    $('postWorkoutControls').style.display = 'none';
    $('exerciseRows').style.display = 'block';

    saveWorkoutState();
    updateWorkoutUI();
    updateExerciseStates();
    startTimer();

    playWhistle();
    haptic(100);

    switchScreen('workout');
    showToast('Workout started!', 'success');
  }

  function resumeWorkout() {
    const saved = loadWorkoutState();
    if (saved && saved.active && !saved.completed) {
      workoutState = saved;
      EX_TARGETS[2] = workoutState.squatsPerRound;
      $('workoutCompleteBanner').style.display = 'none';
      $('workoutControls').style.display = 'flex';
      $('postWorkoutControls').style.display = 'none';
      $('exerciseRows').style.display = 'block';
      updateWorkoutUI();
      updateExerciseStates();
      startTimer();
      switchScreen('workout');
      showToast('Workout resumed!', 'success');
    }
  }

  async function endWorkout() {
    stopTimer();
    endRestTimer();

    playBell();
    haptic(200);

    workoutState.active = false;
    workoutState.completed = true;

    const totalCleans = workoutState.cleansLeft + workoutState.cleansRight;
    const totalPresses = workoutState.pressesLeft + workoutState.pressesRight;

    const workout = {
      mode: workoutState.mode,
      duration: workoutState.duration,
      actualDuration: Math.floor(workoutState.elapsedSeconds / 60),
      weight: workoutState.weight,
      unit: workoutState.unit,
      rounds: workoutState.rounds,
      squatsPerRound: workoutState.squatsPerRound,
      cleans: totalCleans,
      presses: totalPresses,
      squats: workoutState.squats,
      date: new Date().toISOString().split('T')[0],
      timestamp: Date.now()
    };

    await saveWorkout(workout);

    const allWorkouts = await getAllWorkouts();
    const maxRounds = Math.max(...allWorkouts.map(w => w.rounds || 0));
    if (workout.rounds > personalRecord && workout.rounds === maxRounds) {
      showConfetti();
      showToast('New Personal Record!', 'success');
    }
    personalRecord = maxRounds;

    checkAchievements(workout.rounds);

    $('workoutCompleteBanner').style.display = 'block';
    $('workoutControls').style.display = 'none';
    $('postWorkoutControls').style.display = 'flex';
    $('exerciseRows').style.display = 'none';

    clearWorkoutState();
    showToast(`Workout complete! ${workout.rounds} rounds`, 'success');
    updateStats();
  }

  function resetWorkoutScreen() {
    workoutState.active = false;
    workoutState.completed = false;
    workoutState.rounds = 0;
    workoutState.elapsedSeconds = 0;
    workoutState.lastMinuteTick = 0;
    workoutState.currentEx = [0, 0, 0];
    workoutState.roundComplete = [false, false, false];
    workoutState.cleansLeft = 0;
    workoutState.cleansRight = 0;
    workoutState.pressesLeft = 0;
    workoutState.pressesRight = 0;
    workoutState.squats = 0;

    $('workoutCompleteBanner').style.display = 'none';
    $('workoutControls').style.display = 'flex';
    $('postWorkoutControls').style.display = 'none';
    $('exerciseRows').style.display = 'block';

    updateWorkoutUI();
    updateExerciseStates();
    updateTimerDisplay(workoutState.duration * 60);

    switchScreen('setup');
  }

  function updateWorkoutUI() {
    $('roundDisplay').textContent = workoutState.rounds;

    const totalCleans = workoutState.cleansLeft + workoutState.cleansRight;
    const totalPresses = workoutState.pressesLeft + workoutState.pressesRight;

    $('cleanCount').textContent = totalCleans;
    $('pressCount').textContent = totalPresses;
    $('squatCount').textContent = workoutState.squats;

    const target = workoutState.targetRounds || 10;
    const progress = Math.min(100, (workoutState.rounds / target) * 100);
    $('progressFill').style.width = `${progress}%`;
    $('targetLabel').textContent = `Target: ${target} rounds`;

    const labels = { emom: 'EMOM Timer', timedsets: 'Timed Sets Timer', heavy: 'Heavy Day Timer' };
    $('timerLabel').textContent = labels[workoutState.mode] || 'Timer';
  }

  function checkAchievements(rounds) {
    if (rounds === ACHIEVEMENTS.halfViking) showToast('Half-way Viking!', 'success');
    else if (rounds === ACHIEVEMENTS.fullViking) { showToast('30-round legend!', 'success'); showConfetti(); }
    else if (rounds === ACHIEVEMENTS.legend) { showToast('Absolute Legend!', 'success'); showConfetti(); }
  }

  async function renderCalendar() {
    const workouts = await getAllWorkouts();
    const workoutMap = {};
    workouts.forEach(w => {
      if (!workoutMap[w.date]) workoutMap[w.date] = [];
      workoutMap[w.date].push(w);
    });

    const year = calendarDate.getFullYear();
    const month = calendarDate.getMonth();
    const monthNames = ['January','February','March','April','May','June','July','August','September','October','November','December'];
    $('calendarTitle').textContent = `${monthNames[month]} ${year}`;

    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    const startPadding = firstDay.getDay();

    const calendar = $('calendar');
    const headers = Array.from(calendar.querySelectorAll('.calendar-header'));
    calendar.innerHTML = '';
    headers.forEach(h => calendar.appendChild(h));

    const today = new Date().toISOString().split('T')[0];

    for (let i = 0; i < startPadding; i++) {
      const empty = document.createElement('div');
      empty.className = 'calendar-day empty';
      calendar.appendChild(empty);
    }

    for (let day = 1; day <= lastDay.getDate(); day++) {
      const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
      const cell = document.createElement('div');
      cell.className = 'calendar-day';
      cell.textContent = day;
      cell.dataset.date = dateStr;

      if (dateStr === today) cell.classList.add('today');

      if (workoutMap[dateStr]) {
        cell.classList.add('has-workout');
        const total = workoutMap[dateStr].reduce((s, w) => s + (w.rounds || 0), 0);
        if (total < 10) cell.classList.add('light');
        else if (total < 20) cell.classList.add('medium');
        else cell.classList.add('heavy');
      }

      cell.addEventListener('click', () => showWorkoutDetail(dateStr, workoutMap[dateStr]));
      calendar.appendChild(cell);
    }
  }

  function showWorkoutDetail(date, workouts) {
    const container = $('workoutDetail');
    if (!workouts || workouts.length === 0) {
      container.innerHTML = `<div class="workout-detail"><h4>${formatDateDisplay(date)}</h4><p style="color:var(--text-2)">No workout recorded</p></div>`;
      return;
    }

    const totalRounds = workouts.reduce((s, w) => s + (w.rounds || 0), 0);
    const totalCleans = workouts.reduce((s, w) => s + (w.cleans || 0), 0);
    const totalPresses = workouts.reduce((s, w) => s + (w.presses || 0), 0);
    const avgWeight = workouts.reduce((s, w) => s + (w.weight || 0), 0) / workouts.length;

    container.innerHTML = `
      <div class="workout-detail">
        <h4><span>${formatDateDisplay(date)}</span><button class="small danger" data-delete-date="${date}">Delete</button></h4>
        <div class="stats">
          <div class="stat"><div class="stat-value">${totalRounds}</div><div class="stat-label">Rounds</div></div>
          <div class="stat"><div class="stat-value">${avgWeight.toFixed(1)}kg</div><div class="stat-label">Avg Weight</div></div>
          <div class="stat"><div class="stat-value">${totalCleans}</div><div class="stat-label">Cleans</div></div>
          <div class="stat"><div class="stat-value">${totalPresses}</div><div class="stat-label">Presses</div></div>
        </div>
      </div>
    `;

    container.querySelector('[data-delete-date]').addEventListener('click', async () => {
      if (confirm('Delete all workouts for this date?')) {
        for (const w of workouts) await deleteWorkout(w.id);
        renderCalendar();
        container.innerHTML = '';
        showToast('Workout deleted', 'warning');
      }
    });
  }

  function formatDateDisplay(dateStr) {
    const date = new Date(dateStr + 'T12:00:00');
    return date.toLocaleDateString(undefined, { weekday: 'short', month: 'short', day: 'numeric' });
  }

  async function updateStats() {
    const workouts = await getAllWorkouts();
    const totalSessions = workouts.length;
    const totalRounds = workouts.reduce((s, w) => s + (w.rounds || 0), 0);
    const avgWeight = workouts.length > 0 ? workouts.reduce((s, w) => s + (w.weight || 0), 0) / workouts.length : 0;

    let tonnage = 0;
    workouts.forEach(w => {
      const weight = w.weight || 0;
      tonnage += weight * ((w.cleans || 0) * 0.5 + (w.presses || 0) + (w.squats || 0) * 0.75);
    });

    $('statSessions').textContent = totalSessions;
    $('statRounds').textContent = totalRounds;
    $('statAvgWeight').textContent = avgWeight.toFixed(1) + 'kg';
    $('statTonnage').textContent = (tonnage / 1000).toFixed(1) + 't';

    personalRecord = Math.max(...workouts.map(w => w.rounds || 0), 0);
  }

  async function exportJSON() {
    const workouts = await getAllWorkouts();
    downloadFile(JSON.stringify(workouts, null, 2), 'kb-tracker-export.json', 'application/json');
    showToast('Exported JSON', 'success');
  }

  async function exportCSV() {
    const workouts = await getAllWorkouts();
    const headers = ['date','mode','duration','weight','unit','rounds','cleans','presses','squats'];
    const rows = workouts.map(w => headers.map(h => w[h] ?? '').join(','));
    downloadFile([headers.join(','), ...rows].join('\n'), 'kb-tracker-export.csv', 'text/csv');
    showToast('Exported CSV', 'success');
  }

  async function copyToClipboard() {
    const workouts = await getAllWorkouts();
    await navigator.clipboard.writeText(JSON.stringify(workouts, null, 2));
    showToast('Copied to clipboard', 'success');
  }

  function downloadFile(content, filename, type) {
    const blob = new Blob([content], { type });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    a.click();
    URL.revokeObjectURL(url);
  }

  async function importJSON(file) {
    try {
      const text = await file.text();
      const imported = JSON.parse(text);
      if (!Array.isArray(imported)) throw new Error('Invalid format');
      const existing = await getAllWorkouts();
      const existingIds = new Set(existing.map(w => w.id));
      let added = 0;
      for (const workout of imported) {
        if (!workout.date || typeof workout.rounds !== 'number') continue;
        if (!existingIds.has(workout.id)) { await saveWorkout(workout); added++; }
      }
      showToast(`Imported ${added} workouts`, 'success');
      renderCalendar();
      updateStats();
    } catch (error) {
      showToast('Import failed: ' + error.message, 'error');
    }
  }

  function showModal(title, content, actions = []) {
    $('modalTitle').textContent = title;
    $('modalContent').innerHTML = content;
    const actionsContainer = $('modalActions');
    actionsContainer.innerHTML = '';
    actions.forEach(action => {
      const btn = document.createElement('button');
      btn.textContent = action.text;
      btn.className = action.class || '';
      btn.addEventListener('click', () => { action.handler(); if (action.close !== false) closeModal(); });
      actionsContainer.appendChild(btn);
    });
    $('modalOverlay').classList.add('active');
  }

  function closeModal() { $('modalOverlay').classList.remove('active'); }

  function showToast(message, type = 'success') {
    const container = $('toastContainer');
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.innerHTML = `<span>${message}</span>`;
    container.appendChild(toast);
    setTimeout(() => { toast.classList.add('hiding'); setTimeout(() => toast.remove(), 300); }, 3000);
  }

  function showConfetti() {
    const container = $('confettiContainer');
    const colors = ['#f97316', '#22c55e', '#3b82f6', '#eab308', '#ec4899'];
    for (let i = 0; i < 50; i++) {
      const confetti = document.createElement('div');
      confetti.className = 'confetti';
      confetti.style.left = Math.random() * 100 + '%';
      confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
      confetti.style.animationDelay = Math.random() * 0.5 + 's';
      confetti.style.animationDuration = (2 + Math.random()) + 's';
      container.appendChild(confetti);
      setTimeout(() => confetti.remove(), 3500);
    }
  }

  function switchScreen(screenName) {
    $$('.screen').forEach(s => s.classList.remove('active'));
    $(`${screenName}Screen`).classList.add('active');
    $$('.nav button').forEach(b => {
      b.classList.toggle('active', b.dataset.screen === screenName);
      b.setAttribute('aria-current', b.dataset.screen === screenName ? 'page' : 'false');
    });
    if (screenName === 'history') renderCalendar();
    else if (screenName === 'stats') updateStats();
  }

  function initEventListeners() {
    $('themeToggle').addEventListener('click', toggleTheme);

    $('soundToggle').addEventListener('click', () => {
      soundEnabled = !soundEnabled;
      haptic(5);
      showToast(soundEnabled ? 'Sound on' : 'Sound off', 'success');
    });

    $$('.mode-card').forEach(card => {
      card.addEventListener('click', () => {
        $$('.mode-card').forEach(c => { c.classList.remove('selected'); c.setAttribute('aria-checked', 'false'); });
        card.classList.add('selected');
        card.setAttribute('aria-checked', 'true');
        workoutState.mode = card.dataset.mode;

        const slider = $('durationSlider');
        if (card.dataset.mode === 'heavy') {
          slider.min = 15; slider.max = 15; slider.value = 15;
          $('durationValue').textContent = '15 min';
          workoutState.duration = 15;
        } else if (card.dataset.mode === 'timedsets') {
          slider.min = 10; slider.max = 30;
          slider.value = Math.min(Math.max(workoutState.duration, 10), 30);
          $('durationValue').textContent = slider.value + ' min';
          workoutState.duration = parseInt(slider.value);
        } else {
          slider.min = 15; slider.max = 45;
          slider.value = Math.min(Math.max(workoutState.duration, 15), 45);
          $('durationValue').textContent = slider.value + ' min';
          workoutState.duration = parseInt(slider.value);
        }
        
        updateRoundsGoalVisibility();
        haptic(5);
      });
    });

    $('durationSlider').addEventListener('input', (e) => {
      workoutState.duration = parseInt(e.target.value);
      $('durationValue').textContent = `${e.target.value} min`;
    });

    $('weightUp').addEventListener('click', () => {
      const input = $('weightInput');
      input.value = Math.min(92, parseInt(input.value) + 1);
      workoutState.weight = parseInt(input.value);
      haptic(5);
    });

    $('weightDown').addEventListener('click', () => {
      const input = $('weightInput');
      input.value = Math.max(4, parseInt(input.value) - 1);
      workoutState.weight = parseInt(input.value);
      haptic(5);
    });

    $('weightInput').addEventListener('change', (e) => {
      workoutState.weight = parseInt(e.target.value) || 24;
    });

    $('roundsGoalUp').addEventListener('click', () => {
      const input = $('roundsGoalInput');
      input.value = Math.min(99, parseInt(input.value) + 1);
      workoutState.targetRounds = parseInt(input.value);
      haptic(5);
    });

    $('roundsGoalDown').addEventListener('click', () => {
      const input = $('roundsGoalInput');
      input.value = Math.max(1, parseInt(input.value) - 1);
      workoutState.targetRounds = parseInt(input.value);
      haptic(5);
    });

    $('roundsGoalInput').addEventListener('change', (e) => {
      workoutState.targetRounds = parseInt(e.target.value) || 10;
    });

    $$('.unit-toggle button').forEach(btn => {
      btn.addEventListener('click', () => {
        $$('.unit-toggle button').forEach(b => { b.classList.remove('active'); b.setAttribute('aria-checked', 'false'); });
        btn.classList.add('active');
        btn.setAttribute('aria-checked', 'true');
        workoutState.unit = btn.dataset.unit;
        haptic(5);
      });
    });

    $$('[data-squats]').forEach(btn => {
      btn.addEventListener('click', () => {
        $$('[data-squats]').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        workoutState.squatsPerRound = parseInt(btn.dataset.squats);
        EX_TARGETS[2] = workoutState.squatsPerRound;
        saveSettings();
        $('squatTargetLabel').textContent = `(${workoutState.squatsPerRound} reps)`;
        haptic(5);
      });
    });

    $('restSlider').addEventListener('input', (e) => {
      workoutState.restDuration = parseInt(e.target.value);
      $('restValue').textContent = `${e.target.value}s`;
    });

    $('restAdjust').addEventListener('input', (e) => {
      restCountdown = parseInt(e.target.value);
      $('restDisplay').textContent = restCountdown;
    });

    $('startWorkout').addEventListener('click', startWorkout);

    $('exercise1Inc').addEventListener('click', () => incrementExercise(0));
    $('exercise1Dec').addEventListener('click', () => decrementExercise(0));
    $('exercise2Inc').addEventListener('click', () => incrementExercise(1));
    $('exercise2Dec').addEventListener('click', () => decrementExercise(1));
    $('exercise3Inc').addEventListener('click', () => incrementExercise(2));
    $('exercise3Dec').addEventListener('click', () => decrementExercise(2));

    $('restBtn').addEventListener('click', () => {
      if (!workoutState.isResting && workoutState.active) startRestTimer();
    });

    $('skipRest').addEventListener('click', () => { endRestTimer(); playClick(); haptic(10); });

    $('editWeight').addEventListener('click', () => {
      showModal('Edit Weight', `
        <div class="form-group">
          <label>Weight (${workoutState.unit})</label>
          <input type="number" id="modalWeight" value="${workoutState.weight}" min="4" max="92" style="width:100%">
        </div>
        <div class="form-group" style="margin-top:1rem">
          <label>Target Rounds</label>
          <input type="number" id="modalTarget" value="${workoutState.targetRounds}" min="1" max="99" style="width:100%">
        </div>
      `, [
        { text: 'Cancel', handler: closeModal },
        { text: 'Save', class: 'primary', handler: () => {
          workoutState.weight = parseInt($('modalWeight').value) || workoutState.weight;
          workoutState.targetRounds = parseInt($('modalTarget').value) || workoutState.targetRounds;
          updateWorkoutUI();
          showToast('Updated settings', 'success');
        }}
      ]);
    });

    $('endWorkout').addEventListener('click', () => {
      showModal('End Workout?', '<p>This will save your current progress.</p>', [
        { text: 'Cancel', handler: closeModal },
        { text: 'End Workout', class: 'danger', handler: endWorkout }
      ]);
    });

    $('newWorkout').addEventListener('click', resetWorkoutScreen);

    $('prevMonth').addEventListener('click', () => { calendarDate.setMonth(calendarDate.getMonth() - 1); renderCalendar(); });
    $('nextMonth').addEventListener('click', () => { calendarDate.setMonth(calendarDate.getMonth() + 1); renderCalendar(); });

    $('retroDate').valueAsDate = new Date();
    $('saveRetro').addEventListener('click', async () => {
      const rounds = parseInt($('retroRounds').value) || 0;
      const workout = {
        date: $('retroDate').value,
        mode: $('retroMode').value,
        rounds: rounds,
        weight: parseInt($('retroWeight').value) || 24,
        unit: 'kg',
        squatsPerRound: 3,
        cleans: rounds * 2,
        presses: rounds,
        squats: rounds * 3,
        duration: 0,
        timestamp: new Date($('retroDate').value).getTime()
      };
      await saveWorkout(workout);
      showToast('Workout saved!', 'success');
      renderCalendar();
    });

    $('exportJSON').addEventListener('click', exportJSON);
    $('exportCSV').addEventListener('click', exportCSV);
    $('copyClipboard').addEventListener('click', copyToClipboard);

    $('importBtn').addEventListener('click', () => $('importFile').click());
    $('importFile').addEventListener('change', (e) => {
      if (e.target.files[0]) { importJSON(e.target.files[0]); e.target.value = ''; }
    });

    $('clearData').addEventListener('click', () => {
      showModal('Clear All Data?', '<p>This cannot be undone!</p>', [
        { text: 'Cancel', handler: closeModal },
        { text: 'Clear Everything', class: 'danger', handler: async () => {
          await clearAllWorkouts();
          showToast('All data cleared', 'warning');
          updateStats();
          renderCalendar();
        }}
      ]);
    });

    $$('.nav button').forEach(btn => {
      btn.addEventListener('click', () => { switchScreen(btn.dataset.screen); haptic(5); });
    });

    $('modalOverlay').addEventListener('click', (e) => {
      if (e.target === $('modalOverlay')) closeModal();
    });

    document.addEventListener('keydown', (e) => {
      if (!workoutState.active) return;
      if (e.code === 'Digit1' || e.code === 'Numpad1') { e.preventDefault(); incrementExercise(0); }
      else if (e.code === 'Digit2' || e.code === 'Numpad2') { e.preventDefault(); incrementExercise(1); }
      else if (e.code === 'Digit3' || e.code === 'Numpad3') { e.preventDefault(); incrementExercise(2); }
      else if (e.code === 'KeyR') { e.preventDefault(); if (!workoutState.isResting) startRestTimer(); }
    });

    document.addEventListener('visibilitychange', () => {
      if (document.hidden && workoutState.active) saveWorkoutState();
    });

    window.addEventListener('beforeunload', () => {
      if (workoutState.active) saveWorkoutState();
    });
  }

  function registerServiceWorker() {
    if ('serviceWorker' in navigator) {
      const swCode = `
        const CACHE_NAME = 'kb-tracker-v1';
        self.addEventListener('install', () => self.skipWaiting());
        self.addEventListener('activate', (e) => e.waitUntil(self.clients.claim()));
        self.addEventListener('fetch', (e) => {
          e.respondWith(caches.match(e.request).then(r => r || fetch(e.request).then(res => {
            if (res.status === 200) {
              const clone = res.clone();
              caches.open(CACHE_NAME).then(c => c.put(e.request, clone));
            }
            return res;
          })).catch(() => caches.match('/')));
        });
      `;
      const blob = new Blob([swCode], { type: 'application/javascript' });
      navigator.serviceWorker.register(URL.createObjectURL(blob)).catch(() => {});
    }
  }

  function injectManifest() {
    const manifest = {
      name: 'Kettlebell Complex Tracker',
      short_name: 'KB Tracker',
      description: 'Premium offline kettlebell workout tracker',
      start_url: '.',
      display: 'standalone',
      background_color: '#0f172a',
      theme_color: '#0f172a',
      orientation: 'portrait',
      icons: [{
        src: 'data:image/svg+xml,' + encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><rect width="512" height="512" rx="96" fill="#0f172a"/><circle cx="256" cy="300" r="120" fill="#f97316"/><path d="M160 130 Q256 50 352 130" stroke="#f97316" stroke-width="40" fill="none" stroke-linecap="round"/><circle cx="256" cy="300" r="48" fill="#0f172a"/></svg>`),
        sizes: '512x512',
        type: 'image/svg+xml',
        purpose: 'any maskable'
      }]
    };
    const link = document.createElement('link');
    link.rel = 'manifest';
    link.href = URL.createObjectURL(new Blob([JSON.stringify(manifest)], { type: 'application/json' }));
    document.head.appendChild(link);
  }

  async function init() {
    initTheme();
    loadSettings();
    injectManifest();
    registerServiceWorker();
    await initDatabase();
    initEventListeners();

    // Apply saved squat setting to UI
    $$('[data-squats]').forEach(btn => {
      btn.classList.toggle('active', parseInt(btn.dataset.squats) === workoutState.squatsPerRound);
    });
    $('squatTargetLabel').textContent = `(${workoutState.squatsPerRound} reps)`;

    // Set initial visibility for rounds goal
    updateRoundsGoalVisibility();

    updateExerciseStates();

    const savedState = loadWorkoutState();
    if (savedState && savedState.active && !savedState.completed) {
      showModal('Resume Workout?', `<p>You have an unfinished workout with ${savedState.rounds} rounds.</p>`, [
        { text: 'Discard', handler: () => clearWorkoutState() },
        { text: 'Resume', class: 'primary', handler: resumeWorkout }
      ]);
    }

    await updateStats();
    $('retroDate').valueAsDate = new Date();
  }

  if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', init);
  else init();
})();
</script>
</body>
</html>
